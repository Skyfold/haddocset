<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>System/Timeout.hs</title>
<link type="text/css" rel="stylesheet" href="hscolour.css"></link>
</head>
<body>
<pre><a name="line-1"></a><span class="hs-comment">{-# LANGUAGE Trustworthy #-}</span>
<a name="line-2"></a><span class="hs-comment">{-# LANGUAGE CPP #-}</span>
<a name="line-3"></a><span class="hs-cpp">#ifdef __GLASGOW_HASKELL__</span>
<a name="line-4"></a><span class="hs-comment">{-# LANGUAGE DeriveDataTypeable, StandaloneDeriving #-}</span>
<a name="line-5"></a><span class="hs-cpp">#endif</span>
<a name="line-6"></a>
<a name="line-7"></a><span class="hs-comment">-------------------------------------------------------------------------------</span>
<a name="line-8"></a><span class="hs-comment">-- |</span>
<a name="line-9"></a><span class="hs-comment">-- Module      :  System.Timeout</span>
<a name="line-10"></a><span class="hs-comment">-- Copyright   :  (c) The University of Glasgow 2007</span>
<a name="line-11"></a><span class="hs-comment">-- License     :  BSD-style (see the file libraries/base/LICENSE)</span>
<a name="line-12"></a><span class="hs-comment">--</span>
<a name="line-13"></a><span class="hs-comment">-- Maintainer  :  libraries@haskell.org</span>
<a name="line-14"></a><span class="hs-comment">-- Stability   :  experimental</span>
<a name="line-15"></a><span class="hs-comment">-- Portability :  non-portable</span>
<a name="line-16"></a><span class="hs-comment">--</span>
<a name="line-17"></a><span class="hs-comment">-- Attach a timeout event to arbitrary 'IO' computations.</span>
<a name="line-18"></a><span class="hs-comment">--</span>
<a name="line-19"></a><span class="hs-comment">-------------------------------------------------------------------------------</span>
<a name="line-20"></a>
<a name="line-21"></a><span class="hs-cpp">#ifdef __GLASGOW_HASKELL__</span>
<a name="line-22"></a><span class="hs-cpp">#include &quot;Typeable.h&quot;</span>
<a name="line-23"></a><span class="hs-cpp">#endif</span>
<a name="line-24"></a>
<a name="line-25"></a><span class="hs-keyword">module</span> <span class="hs-conid">System</span><span class="hs-varop">.</span><span class="hs-conid">Timeout</span> <span class="hs-layout">(</span> <span class="hs-varid">timeout</span> <span class="hs-layout">)</span> <span class="hs-keyword">where</span>
<a name="line-26"></a>
<a name="line-27"></a><span class="hs-cpp">#ifdef __GLASGOW_HASKELL__</span>
<a name="line-28"></a><span class="hs-keyword">import</span> <span class="hs-conid">Control</span><span class="hs-varop">.</span><span class="hs-conid">Concurrent</span>
<a name="line-29"></a><span class="hs-keyword">import</span> <span class="hs-conid">Control</span><span class="hs-varop">.</span><span class="hs-conid">Exception</span>   <span class="hs-layout">(</span><span class="hs-conid">Exception</span><span class="hs-layout">,</span> <span class="hs-varid">handleJust</span><span class="hs-layout">,</span> <span class="hs-varid">bracket</span><span class="hs-layout">)</span>
<a name="line-30"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Typeable</span>
<a name="line-31"></a><span class="hs-keyword">import</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Unique</span>         <span class="hs-layout">(</span><span class="hs-conid">Unique</span><span class="hs-layout">,</span> <span class="hs-varid">newUnique</span><span class="hs-layout">)</span>
<a name="line-32"></a>
<a name="line-33"></a><span class="hs-comment">-- An internal type that is thrown as a dynamic exception to</span>
<a name="line-34"></a><span class="hs-comment">-- interrupt the running IO computation when the timeout has</span>
<a name="line-35"></a><span class="hs-comment">-- expired.</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="Timeout"></a><span class="hs-keyword">newtype</span> <span class="hs-conid">Timeout</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">Timeout</span> <span class="hs-conid">Unique</span> <span class="hs-keyword">deriving</span> <span class="hs-conid">Eq</span>
<a name="line-38"></a><span class="hs-conid">INSTANCE_TYPEABLE0</span><span class="hs-layout">(</span><span class="hs-conid">Timeout</span><span class="hs-layout">,</span><span class="hs-varid">timeoutTc</span><span class="hs-layout">,</span><span class="hs-str">&quot;Timeout&quot;</span><span class="hs-layout">)</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="instance%20Show%20Timeout"></a><span class="hs-keyword">instance</span> <span class="hs-conid">Show</span> <span class="hs-conid">Timeout</span> <span class="hs-keyword">where</span>
<a name="line-41"></a>    <span class="hs-varid">show</span> <span class="hs-keyword">_</span> <span class="hs-keyglyph">=</span> <span class="hs-str">&quot;&lt;&lt;timeout&gt;&gt;&quot;</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="instance%20Exception%20Timeout%20%23endif%20/*%20!__GLASGOW_HASKELL__%20*/%20--%20%7cWrap%20an%20'IO'%20computation%20to%20time%20out%20and%20return%20@Nothing@%20in%20case%20no%20result%20--%20is%20available%20within%20@n@%20microseconds%20(@1%5c/10%5e6@%20seconds).%20In%20case%20a%20result%20--%20is%20available%20before%20the%20timeout%20expires,%20@Just%20a@%20is%20returned.%20A%20negative%20--%20timeout%20interval%20means%20%5c%22wait%20indefinitely%5c%22.%20When%20specifying%20long%20timeouts,%20--%20be%20careful%20not%20to%20exceed%20@maxBound%20::%20Int@.%20--%20--%20The%20design%20of%20this%20combinator%20was%20guided%20by%20the%20objective%20that%20@timeout%20n%20f@%20--%20should%20behave%20exactly%20the%20same%20as%20@f@%20as%20long%20as%20@f@%20doesn't%20time%20out.%20This%20--%20means%20that%20@f@%20has%20the%20same%20'myThreadId'%20it%20would%20have%20without%20the%20timeout%20--%20wrapper.%20Any%20exceptions%20@f@%20might%20throw%20cancel%20the%20timeout%20and%20propagate%20--%20further%20up.%20It%20also%20possible%20for%20@f@%20to%20receive%20exceptions%20thrown%20to%20it%20by%20--%20another%20thread.%20--%20--%20A%20tricky%20implementation%20detail%20is%20the%20question%20of%20how%20to%20abort%20an%20@IO@%20--%20computation.%20This%20combinator%20relies%20on%20asynchronous%20exceptions%20internally.%20--%20The%20technique%20works%20very%20well%20for%20computations%20executing%20inside%20of%20the%20--%20Haskell%20runtime%20system,%20but%20it%20doesn't%20work%20at%20all%20for%20non-Haskell%20code.%20--%20Foreign%20function%20calls,%20for%20example,%20cannot%20be%20timed%20out%20with%20this%20--%20combinator%20simply%20because%20an%20arbitrary%20C%20function%20cannot%20receive%20--%20asynchronous%20exceptions.%20When%20@timeout@%20is%20used%20to%20wrap%20an%20FFI%20call%20that%20--%20blocks,%20no%20timeout%20event%20can%20be%20delivered%20until%20the%20FFI%20call%20returns,%20which%20--%20pretty%20much%20negates%20the%20purpose%20of%20the%20combinator.%20In%20practice,%20however,%20--%20this%20limitation%20is%20less%20severe%20than%20it%20may%20sound.%20Standard%20I%5c/O%20functions%20--%20like%20'System.IO.hGetBuf',%20'System.IO.hPutBuf',%20Network.Socket.accept,%20or%20--%20'System.IO.hWaitForInput'%20appear%20to%20be%20blocking,%20but%20they%20really%20don't%20--%20because%20the%20runtime%20system%20uses%20scheduling%20mechanisms%20like%20@select(2)@%20to%20--%20perform%20asynchronous%20I%5c/O,%20so%20it%20is%20possible%20to%20interrupt%20standard%20socket%20--%20I%5c/O%20or%20file%20I%5c/O%20using%20this%20combinator.%20timeout%20::%20Int%20-%3e%20IO%20a%20-%3e%20IO%20(Maybe%20a)%20%23ifdef%20__GLASGOW_HASKELL__%20timeout%20n%20f%20%7c%20n%20%3c%200%20=%20fmap%20Just%20f%20%7c%20n%20==%200%20=%20return%20Nothing%20%7c%20otherwise%20=%20do%20pid%20%3c-%20myThreadId%20ex%20%3c-%20fmap%20Timeout%20newUnique%20handleJust%20(%5ce%20-%3e%20if%20e%20==%20ex%20then%20Just%20()%20else%20Nothing)%20(%5c_%20-%3e%20return%20Nothing)%20(bracket%20(forkIOWithUnmask%20$%20%5cunmask%20-%3e%20unmask%20$%20threadDelay%20n%20%3e%3e%20throwTo%20pid%20ex)%20(killThread)%20(%5c_%20-%3e%20fmap%20Just%20f))%20%23else%20timeout%20n%20f%20=%20fmap%20Just%20f%20%23endif%20/*%20!__GLASGOW_HASKELL__%20*/"></a><span class="hs-keyword">instance</span> <span class="hs-conid">Exception</span> <span class="hs-conid">Timeout</span>
<a name="line-44"></a><span class="hs-cpp">#endif /* !__GLASGOW_HASKELL__ */</span>
<a name="line-45"></a>
<a name="line-46"></a><span class="hs-comment">-- |Wrap an 'IO' computation to time out and return @Nothing@ in case no result</span>
<a name="line-47"></a><span class="hs-comment">-- is available within @n@ microseconds (@1\/10^6@ seconds). In case a result</span>
<a name="line-48"></a><span class="hs-comment">-- is available before the timeout expires, @Just a@ is returned. A negative</span>
<a name="line-49"></a><span class="hs-comment">-- timeout interval means \&quot;wait indefinitely\&quot;. When specifying long timeouts,</span>
<a name="line-50"></a><span class="hs-comment">-- be careful not to exceed @maxBound :: Int@.</span>
<a name="line-51"></a><span class="hs-comment">--</span>
<a name="line-52"></a><span class="hs-comment">-- The design of this combinator was guided by the objective that @timeout n f@</span>
<a name="line-53"></a><span class="hs-comment">-- should behave exactly the same as @f@ as long as @f@ doesn't time out. This</span>
<a name="line-54"></a><span class="hs-comment">-- means that @f@ has the same 'myThreadId' it would have without the timeout</span>
<a name="line-55"></a><span class="hs-comment">-- wrapper. Any exceptions @f@ might throw cancel the timeout and propagate</span>
<a name="line-56"></a><span class="hs-comment">-- further up. It also possible for @f@ to receive exceptions thrown to it by</span>
<a name="line-57"></a><span class="hs-comment">-- another thread.</span>
<a name="line-58"></a><span class="hs-comment">--</span>
<a name="line-59"></a><span class="hs-comment">-- A tricky implementation detail is the question of how to abort an @IO@</span>
<a name="line-60"></a><span class="hs-comment">-- computation. This combinator relies on asynchronous exceptions internally.</span>
<a name="line-61"></a><span class="hs-comment">-- The technique works very well for computations executing inside of the</span>
<a name="line-62"></a><span class="hs-comment">-- Haskell runtime system, but it doesn't work at all for non-Haskell code.</span>
<a name="line-63"></a><span class="hs-comment">-- Foreign function calls, for example, cannot be timed out with this</span>
<a name="line-64"></a><span class="hs-comment">-- combinator simply because an arbitrary C function cannot receive</span>
<a name="line-65"></a><span class="hs-comment">-- asynchronous exceptions. When @timeout@ is used to wrap an FFI call that</span>
<a name="line-66"></a><span class="hs-comment">-- blocks, no timeout event can be delivered until the FFI call returns, which</span>
<a name="line-67"></a><span class="hs-comment">-- pretty much negates the purpose of the combinator. In practice, however,</span>
<a name="line-68"></a><span class="hs-comment">-- this limitation is less severe than it may sound. Standard I\/O functions</span>
<a name="line-69"></a><span class="hs-comment">-- like 'System.IO.hGetBuf', 'System.IO.hPutBuf', Network.Socket.accept, or</span>
<a name="line-70"></a><span class="hs-comment">-- 'System.IO.hWaitForInput' appear to be blocking, but they really don't</span>
<a name="line-71"></a><span class="hs-comment">-- because the runtime system uses scheduling mechanisms like @select(2)@ to</span>
<a name="line-72"></a><span class="hs-comment">-- perform asynchronous I\/O, so it is possible to interrupt standard socket</span>
<a name="line-73"></a><span class="hs-comment">-- I\/O or file I\/O using this combinator.</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="timeout"></a><span class="hs-definition">timeout</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">Maybe</span> <span class="hs-varid">a</span><span class="hs-layout">)</span>
<a name="line-76"></a><span class="hs-cpp">#ifdef __GLASGOW_HASKELL__</span>
<a name="line-77"></a><span class="hs-definition">timeout</span> <span class="hs-varid">n</span> <span class="hs-varid">f</span>
<a name="line-78"></a>    <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">&lt;</span>  <span class="hs-num">0</span>    <span class="hs-keyglyph">=</span> <span class="hs-varid">fmap</span> <span class="hs-conid">Just</span> <span class="hs-varid">f</span>
<a name="line-79"></a>    <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>    <span class="hs-keyglyph">=</span> <span class="hs-varid">return</span> <span class="hs-conid">Nothing</span>
<a name="line-80"></a>    <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-81"></a>        <span class="hs-varid">pid</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">myThreadId</span>
<a name="line-82"></a>        <span class="hs-varid">ex</span>  <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">fmap</span> <span class="hs-conid">Timeout</span> <span class="hs-varid">newUnique</span>
<a name="line-83"></a>        <span class="hs-varid">handleJust</span> <span class="hs-layout">(</span><span class="hs-keyglyph">\</span><span class="hs-varid">e</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-keyword">if</span> <span class="hs-varid">e</span> <span class="hs-varop">==</span> <span class="hs-varid">ex</span> <span class="hs-keyword">then</span> <span class="hs-conid">Just</span> <span class="hs-conid">()</span> <span class="hs-keyword">else</span> <span class="hs-conid">Nothing</span><span class="hs-layout">)</span>
<a name="line-84"></a>                   <span class="hs-layout">(</span><span class="hs-keyglyph">\</span><span class="hs-keyword">_</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">return</span> <span class="hs-conid">Nothing</span><span class="hs-layout">)</span>
<a name="line-85"></a>                   <span class="hs-layout">(</span><span class="hs-varid">bracket</span> <span class="hs-layout">(</span><span class="hs-varid">forkIOWithUnmask</span> <span class="hs-varop">$</span> <span class="hs-keyglyph">\</span><span class="hs-varid">unmask</span> <span class="hs-keyglyph">-&gt;</span>
<a name="line-86"></a>                                 <span class="hs-varid">unmask</span> <span class="hs-varop">$</span> <span class="hs-varid">threadDelay</span> <span class="hs-varid">n</span> <span class="hs-varop">&gt;&gt;</span> <span class="hs-varid">throwTo</span> <span class="hs-varid">pid</span> <span class="hs-varid">ex</span><span class="hs-layout">)</span>
<a name="line-87"></a>                            <span class="hs-layout">(</span><span class="hs-varid">killThread</span><span class="hs-layout">)</span>
<a name="line-88"></a>                            <span class="hs-layout">(</span><span class="hs-keyglyph">\</span><span class="hs-keyword">_</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">fmap</span> <span class="hs-conid">Just</span> <span class="hs-varid">f</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-89"></a><span class="hs-cpp">#else</span>
<a name="line-90"></a><span class="hs-definition">timeout</span> <span class="hs-varid">n</span> <span class="hs-varid">f</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">fmap</span> <span class="hs-conid">Just</span> <span class="hs-varid">f</span>
<a name="line-91"></a><span class="hs-cpp">#endif /* !__GLASGOW_HASKELL__ */</span>
<a name="line-92"></a>
</pre></body>
</html>
