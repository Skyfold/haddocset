<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Data/ByteString/Lazy/Builder/BasicEncoding/Extras.hs</title>
<link type="text/css" rel="stylesheet" href="hscolour.css"></link>
</head>
<body>
<pre><a name="line-1"></a><span class="hs-comment">{-# LANGUAGE CPP, BangPatterns, ScopedTypeVariables #-}</span>
<a name="line-2"></a><span class="hs-comment">{-# OPTIONS_GHC -fno-warn-unused-imports #-}</span>
<a name="line-3"></a><span class="hs-comment">{-# OPTIONS_HADDOCK hide #-}</span>
<a name="line-4"></a><span class="hs-comment">{- | Copyright : (c) 2010-2011 Simon Meier
<a name="line-5"></a>License        : BSD3-style (see LICENSE)
<a name="line-6"></a>
<a name="line-7"></a>Maintainer     : Simon Meier &lt;iridcode@gmail.com&gt;
<a name="line-8"></a>Stability      : experimental
<a name="line-9"></a>Portability    : GHC
<a name="line-10"></a>
<a name="line-11"></a>An /encoding/ is a conversion function of Haskell values to sequences of bytes.
<a name="line-12"></a>A /fixed(-size) encoding/ is an encoding that always results in sequence of bytes
<a name="line-13"></a>  of a pre-determined, fixed length.
<a name="line-14"></a>An example for a fixed encoding is the big-endian encoding of a 'Word64',
<a name="line-15"></a>  which always results in exactly 8 bytes.
<a name="line-16"></a>A /bounded(-size) encoding/ is an encoding that always results in sequence
<a name="line-17"></a>  of bytes that is no larger than a pre-determined bound.
<a name="line-18"></a>An example for a bounded encoding is the UTF-8 encoding of a 'Char',
<a name="line-19"></a>  which results always in less or equal to 4 bytes.
<a name="line-20"></a>Note that every fixed encoding is also a bounded encoding.
<a name="line-21"></a>We explicitly identify fixed encodings because they allow some optimizations
<a name="line-22"></a>  that are impossible with bounded encodings.
<a name="line-23"></a>In the following,
<a name="line-24"></a>  we first motivate the use of bounded encodings
<a name="line-25"></a>  and then give examples of optimizations
<a name="line-26"></a>  that are only possible with fixed encodings.
<a name="line-27"></a>
<a name="line-28"></a>Typicall, encodings are implemented efficiently by allocating a buffer
<a name="line-29"></a>  (a mutable array of bytes)
<a name="line-30"></a>  and repeatedly executing the following two steps:
<a name="line-31"></a>  (1) writing to the buffer until it is full and
<a name="line-32"></a>  (2) handing over the filled part to the consumer of the encoded value.
<a name="line-33"></a>Step (1) is where bounded encodings are used.
<a name="line-34"></a>We must use a bounded encoding,
<a name="line-35"></a>  as we must check that there is enough free space
<a name="line-36"></a>  /before/ actually writing to the buffer.
<a name="line-37"></a>
<a name="line-38"></a>In term of expressivity,
<a name="line-39"></a>  it would be sufficient to construct all encodings
<a name="line-40"></a>  from the single fixed encoding that encodes a 'Word8' as-is.
<a name="line-41"></a>However,
<a name="line-42"></a>  this is not sufficient in terms of efficiency.
<a name="line-43"></a>It results in unnecessary buffer-full checks and
<a name="line-44"></a>  it complicates the program-flow for writing to the buffer,
<a name="line-45"></a>  as buffer-full checks are interleaved with analyzing the value to be
<a name="line-46"></a>  encoded (e.g., think about the program-flow for UTF-8 encoding).
<a name="line-47"></a>This has a significant effect on overall encoding performance,
<a name="line-48"></a>  as encoding primitive Haskell values such as 'Word8's or 'Char's
<a name="line-49"></a>  lies at the heart of every encoding implementation.
<a name="line-50"></a>
<a name="line-51"></a>The 'BoundedEncoding's provided by this module remove this performance problem.
<a name="line-52"></a>Intuitively,
<a name="line-53"></a>  they consist of a tuple of the bound on the maximal number of bytes written
<a name="line-54"></a>  and the actual implementation of the encoding as
<a name="line-55"></a>  a function that modifies a mutable buffer.
<a name="line-56"></a>Hence when executing a 'BoundedEncoding',
<a name="line-57"></a> the buffer-full check can be done once before the actual writing to the buffer.
<a name="line-58"></a>The provided 'BoundedEncoding's also take care to implement the
<a name="line-59"></a>  actual writing to the buffer efficiently.
<a name="line-60"></a>Moreover, combinators are provided to construct new bounded encodings
<a name="line-61"></a>  from the provided ones.
<a name="line-62"></a>
<a name="line-63"></a>
<a name="line-64"></a>
<a name="line-65"></a>The result of an encoding can be consumed efficiently,
<a name="line-66"></a>  if it is represented as a sequence of large enough
<a name="line-67"></a>  /chunks/ of consecutive memory (i.e., C @char@ arrays).
<a name="line-68"></a>The precise meaning of /large enough/ is application dependent.
<a name="line-69"></a>Typically, an average chunk size between 4kb and 32kb is suitable
<a name="line-70"></a>  for writing the result to disk or sending it over the network.
<a name="line-71"></a>We desire large enough chunk sizes because each chunk boundary
<a name="line-72"></a>  incurs extra work that we must be able to amortize.
<a name="line-73"></a>
<a name="line-74"></a>
<a name="line-75"></a>The need for fixed-size encodings arises when considering
<a name="line-76"></a>  the efficient implementation of encodings that require the encoding of a
<a name="line-77"></a>  value to be prefixed with the size of the resulting sequence of bytes.
<a name="line-78"></a>An efficient implementation avoids unnecessary buffer
<a name="line-79"></a>We can implement this efficiently as follows.
<a name="line-80"></a>We first reserve the space for the encoding of the size.
<a name="line-81"></a>Then, we encode the value.
<a name="line-82"></a>Finally, we encode the size of the resulting sequence of bytes into
<a name="line-83"></a>  the reserved space.
<a name="line-84"></a>For this to work
<a name="line-85"></a>
<a name="line-86"></a>This works only if the encoding resulting size fits
<a name="line-87"></a>
<a name="line-88"></a>by first, reserving the space for the encoding
<a name="line-89"></a>  of the size, then performing the
<a name="line-90"></a>
<a name="line-91"></a>For efficiency,
<a name="line-92"></a>  we want to avoid unnecessary copying.
<a name="line-93"></a>
<a name="line-94"></a>
<a name="line-95"></a>For example, the HTTP/1.0 requires the size of the body to be given in
<a name="line-96"></a>  the Content-Length field.
<a name="line-97"></a>
<a name="line-98"></a>chunked-transfer encoding requires each chunk to
<a name="line-99"></a>  be prefixed with the hexadecimal encoding of the chunk size.
<a name="line-100"></a>
<a name="line-101"></a>
<a name="line-102"></a>-}</span>
<a name="line-103"></a>
<a name="line-104"></a><span class="hs-comment">{-
<a name="line-105"></a>--
<a name="line-106"></a>--
<a name="line-107"></a>-- A /bounded encoding/ is an encoding that never results in a sequence
<a name="line-108"></a>-- longer than some fixed number of bytes. This number of bytes must be
<a name="line-109"></a>-- independent of the value being encoded. Typical examples of bounded
<a name="line-110"></a>-- encodings are the big-endian encoding of a 'Word64', which results always
<a name="line-111"></a>-- in exactly 8 bytes, or the UTF-8 encoding of a 'Char', which results always
<a name="line-112"></a>-- in less or equal to 4 bytes.
<a name="line-113"></a>--
<a name="line-114"></a>-- Typically, encodings are implemented efficiently by allocating a buffer (an
<a name="line-115"></a>-- array of bytes) and repeatedly executing the following two steps: (1)
<a name="line-116"></a>-- writing to the buffer until it is full and (2) handing over the filled part
<a name="line-117"></a>-- to the consumer of the encoded value. Step (1) is where bounded encodings
<a name="line-118"></a>-- are used. We must use a bounded encoding, as we must check that there is
<a name="line-119"></a>-- enough free space /before/ actually writing to the buffer.
<a name="line-120"></a>--
<a name="line-121"></a>-- In term of expressivity, it would be sufficient to construct all encodings
<a name="line-122"></a>-- from the single bounded encoding that encodes a 'Word8' as-is. However,
<a name="line-123"></a>-- this is not sufficient in terms of efficiency. It results in unnecessary
<a name="line-124"></a>-- buffer-full checks and it complicates the program-flow for writing to the
<a name="line-125"></a>-- buffer, as buffer-full checks are interleaved with analyzing the value to be
<a name="line-126"></a>-- encoded (e.g., think about the program-flow for UTF-8 encoding). This has a
<a name="line-127"></a>-- significant effect on overall encoding performance, as encoding primitive
<a name="line-128"></a>-- Haskell values such as 'Word8's or 'Char's lies at the heart of every
<a name="line-129"></a>-- encoding implementation.
<a name="line-130"></a>--
<a name="line-131"></a>-- The bounded 'Encoding's provided by this module remove this performance
<a name="line-132"></a>-- problem. Intuitively, they consist of a tuple of the bound on the maximal
<a name="line-133"></a>-- number of bytes written and the actual implementation of the encoding as a
<a name="line-134"></a>-- function that modifies a mutable buffer. Hence when executing a bounded
<a name="line-135"></a>-- 'Encoding', the buffer-full check can be done once before the actual writing
<a name="line-136"></a>-- to the buffer. The provided 'Encoding's also take care to implement the
<a name="line-137"></a>-- actual writing to the buffer efficiently. Moreover, combinators are
<a name="line-138"></a>-- provided to construct new bounded encodings from the provided ones.
<a name="line-139"></a>--
<a name="line-140"></a>-- A typical example for using the combinators is a bounded 'Encoding' that
<a name="line-141"></a>-- combines escaping the ' and \\ characters with UTF-8 encoding. More
<a name="line-142"></a>-- precisely, the escaping to be done is the one implemented by the following
<a name="line-143"></a>-- @escape@ function.
<a name="line-144"></a>--
<a name="line-145"></a>-- &gt; escape :: Char -&gt; [Char]
<a name="line-146"></a>-- &gt; escape '\'' = &quot;\\'&quot;
<a name="line-147"></a>-- &gt; escape '\\' = &quot;\\\\&quot;
<a name="line-148"></a>-- &gt; escape c    = [c]
<a name="line-149"></a>--
<a name="line-150"></a>-- The bounded 'Encoding' that combines this escaping with UTF-8 encoding is
<a name="line-151"></a>-- the following.
<a name="line-152"></a>--
<a name="line-153"></a>-- &gt; import Data.ByteString.Lazy.Builder.BasicEncoding.Utf8 (char)
<a name="line-154"></a>-- &gt;
<a name="line-155"></a>-- &gt; {-# INLINE escapeChar #-}
<a name="line-156"></a>-- &gt; escapeUtf8 :: BoundedEncoding Char
<a name="line-157"></a>-- &gt; escapeUtf8 =
<a name="line-158"></a>-- &gt;     encodeIf ('\'' ==) (char &lt;#&gt; char #. const ('\\','\'')) $
<a name="line-159"></a>-- &gt;     encodeIf ('\\' ==) (char &lt;#&gt; char #. const ('\\','\\')) $
<a name="line-160"></a>-- &gt;     char
<a name="line-161"></a>--
<a name="line-162"></a>-- The definition of 'escapeUtf8' is more complicated than 'escape', because
<a name="line-163"></a>-- the combinators ('encodeIf', 'encodePair', '#.', and 'char') used in
<a name="line-164"></a>-- 'escapeChar' compute both the bound on the maximal number of bytes written
<a name="line-165"></a>-- (8 for 'escapeUtf8') as well as the low-level buffer manipulation required
<a name="line-166"></a>-- to implement the encoding. Bounded 'Encoding's should always be inlined.
<a name="line-167"></a>-- Otherwise, the compiler cannot compute the bound on the maximal number of
<a name="line-168"></a>-- bytes written at compile-time. Without inlinining, it would also fail to
<a name="line-169"></a>-- optimize the constant encoding of the escape characters in the above
<a name="line-170"></a>-- example. Functions that execute bounded 'Encoding's also perform
<a name="line-171"></a>-- suboptimally, if the definition of the bounded 'Encoding' is not inlined.
<a name="line-172"></a>-- Therefore we add an 'INLINE' pragma to 'escapeUtf8'.
<a name="line-173"></a>--
<a name="line-174"></a>-- Currently, the only library that executes bounded 'Encoding's is the
<a name="line-175"></a>-- 'bytestring' library (&lt;<a href="http://hackage.haskell.org/package/bytestring">http://hackage.haskell.org/package/bytestring</a>&gt;). It
<a name="line-176"></a>-- uses bounded 'Encoding's to implement most of its lazy bytestring builders.
<a name="line-177"></a>-- Executing a bounded encoding should be done using the corresponding
<a name="line-178"></a>-- functions in the lazy bytestring builder 'Extras' module.
<a name="line-179"></a>--
<a name="line-180"></a>-- TODO: Merge with explanation/example below
<a name="line-181"></a>--
<a name="line-182"></a>-- Bounded 'E.Encoding's abstract encodings of Haskell values that can be implemented by
<a name="line-183"></a>-- writing a bounded-size sequence of bytes directly to memory. They are
<a name="line-184"></a>-- lifted to conversions from Haskell values to 'Builder's by wrapping them
<a name="line-185"></a>-- with a bound-check. The compiler can implement this bound-check very
<a name="line-186"></a>-- efficiently (i.e, a single comparison of the difference of two pointers to a
<a name="line-187"></a>-- constant), because the bound of a 'E.Encoding' is always independent of the
<a name="line-188"></a>-- value being encoded and, in most cases, a literal constant.
<a name="line-189"></a>--
<a name="line-190"></a>-- 'E.Encoding's are the primary means for defining conversion functions from
<a name="line-191"></a>-- primitive Haskell values to 'Builder's. Most 'Builder' constructors
<a name="line-192"></a>-- provided by this library are implemented that way.
<a name="line-193"></a>-- 'E.Encoding's are also used to construct conversions that exploit the internal
<a name="line-194"></a>-- representation of data-structures.
<a name="line-195"></a>--
<a name="line-196"></a>-- For example, 'encodeByteStringWith' works directly on the underlying byte
<a name="line-197"></a>-- array and uses some tricks to reduce the number of variables in its inner
<a name="line-198"></a>-- loop. Its efficiency is exploited for implementing the @filter@ and @map@
<a name="line-199"></a>-- functions in &quot;Data.ByteString.Lazy&quot; as
<a name="line-200"></a>--
<a name="line-201"></a>-- &gt; import qualified Codec.Bounded.Encoding as E
<a name="line-202"></a>-- &gt;
<a name="line-203"></a>-- &gt; filter :: (Word8 -&gt; Bool) -&gt; ByteString -&gt; ByteString
<a name="line-204"></a>-- &gt; filter p = toLazyByteString . encodeLazyByteStringWithB write
<a name="line-205"></a>-- &gt;   where
<a name="line-206"></a>-- &gt;     write = E.encodeIf p E.word8 E.emptyEncoding
<a name="line-207"></a>-- &gt;
<a name="line-208"></a>-- &gt; map :: (Word8 -&gt; Word8) -&gt; ByteString -&gt; ByteString
<a name="line-209"></a>-- &gt; map f = toLazyByteString . encodeLazyByteStringWithB (E.word8 E.#. f)
<a name="line-210"></a>--
<a name="line-211"></a>-- Compared to earlier versions of @filter@ and @map@ on lazy 'L.ByteString's,
<a name="line-212"></a>-- these versions use a more efficient inner loop and have the additional
<a name="line-213"></a>-- advantage that they always result in well-chunked 'L.ByteString's; i.e, they
<a name="line-214"></a>-- also perform automatic defragmentation.
<a name="line-215"></a>--
<a name="line-216"></a>-- We can also use 'E.Encoding's to improve the efficiency of the following
<a name="line-217"></a>-- 'renderString' function from our UTF-8 CSV table encoding example in
<a name="line-218"></a>-- &quot;Data.ByteString.Lazy.Builder&quot;.
<a name="line-219"></a>--
<a name="line-220"></a>-- &gt; renderString :: String -&gt; Builder
<a name="line-221"></a>-- &gt; renderString cs = charUtf8 '&quot;' &lt;&gt; foldMap escape cs &lt;&gt; charUtf8 '&quot;'
<a name="line-222"></a>-- &gt;   where
<a name="line-223"></a>-- &gt;     escape '\\' = charUtf8 '\\' &lt;&gt; charUtf8 '\\'
<a name="line-224"></a>-- &gt;     escape '\&quot;' = charUtf8 '\\' &lt;&gt; charUtf8 '\&quot;'
<a name="line-225"></a>-- &gt;     escape c    = charUtf8 c
<a name="line-226"></a>--
<a name="line-227"></a>-- The idea is to save on 'mappend's by implementing a 'E.Encoding' that escapes
<a name="line-228"></a>-- characters and using 'encodeListWith', which implements writing a list of
<a name="line-229"></a>-- values with a tighter inner loop and no 'mappend'.
<a name="line-230"></a>--
<a name="line-231"></a>-- &gt; import Data.ByteString.Lazy.Builder.Extras     -- assume these three
<a name="line-232"></a>-- &gt; import Codec.Bounded.Encoding                  -- imports are present
<a name="line-233"></a>-- &gt;        ( BoundedEncoding, encodeIf, (&lt;#&gt;), (#.) )
<a name="line-234"></a>-- &gt; import Data.ByteString.Lazy.Builder.BasicEncoding.Utf8 (char)
<a name="line-235"></a>-- &gt;
<a name="line-236"></a>-- &gt; renderString :: String -&gt; Builder
<a name="line-237"></a>-- &gt; renderString cs =
<a name="line-238"></a>-- &gt;     charUtf8 '&quot;' &lt;&gt; encodeListWithB escapedUtf8 cs &lt;&gt; charUtf8 '&quot;'
<a name="line-239"></a>-- &gt;   where
<a name="line-240"></a>-- &gt;     escapedUtf8 :: BoundedEncoding Char
<a name="line-241"></a>-- &gt;     escapedUtf8 =
<a name="line-242"></a>-- &gt;       encodeIf (== '\\') (char &lt;#&gt; char #. const ('\\', '\\')) $
<a name="line-243"></a>-- &gt;       encodeIf (== '\&quot;') (char &lt;#&gt; char #. const ('\\', '\&quot;')) $
<a name="line-244"></a>-- &gt;       char
<a name="line-245"></a>--
<a name="line-246"></a>-- This 'Builder' considers a buffer with less than 8 free bytes as full. As
<a name="line-247"></a>-- all functions are inlined, the compiler is able to optimize the constant
<a name="line-248"></a>-- 'E.Encoding's as two sequential 'poke's. Compared to the first implementation of
<a name="line-249"></a>-- 'renderString' this implementation is 1.7x faster.
<a name="line-250"></a>--
<a name="line-251"></a>-}</span>
<a name="line-252"></a><span class="hs-comment">{-
<a name="line-253"></a>Internally, 'Builder's are buffer-fill operations that are
<a name="line-254"></a>given a continuation buffer-fill operation and a buffer-range to be filled.
<a name="line-255"></a>A 'Builder' first checks if the buffer-range is large enough. If that's
<a name="line-256"></a>the case, the 'Builder' writes the sequences of bytes to the buffer and
<a name="line-257"></a>calls its continuation.  Otherwise, it returns a signal that it requires a
<a name="line-258"></a>new buffer together with a continuation to be called on this new buffer.
<a name="line-259"></a>Ignoring the rare case of a full buffer-range, the execution cost of a
<a name="line-260"></a>'Builder' consists of three parts:
<a name="line-261"></a>
<a name="line-262"></a>  1. The time taken to read the parameters; i.e., the buffer-fill
<a name="line-263"></a>     operation to call after the 'Builder' is done and the buffer-range to
<a name="line-264"></a>     fill.
<a name="line-265"></a>
<a name="line-266"></a>  2. The time taken to check for the size of the buffer-range.
<a name="line-267"></a>
<a name="line-268"></a>  3. The time taken for the actual encoding.
<a name="line-269"></a>
<a name="line-270"></a>We can reduce cost (1) by ensuring that fewer buffer-fill function calls are
<a name="line-271"></a>required. We can reduce cost (2) by fusing buffer-size checks of sequential
<a name="line-272"></a>writes. For example, when escaping a 'String' using 'renderString', it would
<a name="line-273"></a>be sufficient to check before encoding a character that at least 8 bytes are
<a name="line-274"></a>free. We can reduce cost (3) by implementing better primitive 'Builder's.
<a name="line-275"></a>For example, 'renderCell' builds an intermediate list containing the decimal
<a name="line-276"></a>representation of an 'Int'. Implementing a direct decimal encoding of 'Int's
<a name="line-277"></a>to memory would be more efficient, as it requires fewer buffer-size checks
<a name="line-278"></a>and less allocation. It is also a planned extension of this library.
<a name="line-279"></a>
<a name="line-280"></a>The first two cost reductions are supported for user code through functions
<a name="line-281"></a>in &quot;Data.ByteString.Lazy.Builder.Extras&quot;. There, we continue the above example
<a name="line-282"></a>and drop the generation time to 0.8ms by implementing 'renderString' more
<a name="line-283"></a>cleverly. The third reduction requires meddling with the internals of
<a name="line-284"></a>'Builder's and is not recomended in code outside of this library. However,
<a name="line-285"></a>patches to this library are very welcome.
<a name="line-286"></a>-}</span>
<a name="line-287"></a><span class="hs-keyword">module</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">ByteString</span><span class="hs-varop">.</span><span class="hs-conid">Lazy</span><span class="hs-varop">.</span><span class="hs-conid">Builder</span><span class="hs-varop">.</span><span class="hs-conid">BasicEncoding</span><span class="hs-varop">.</span><span class="hs-conid">Extras</span> <span class="hs-layout">(</span>
<a name="line-288"></a>
<a name="line-289"></a>  <span class="hs-comment">-- * Base-128, variable-length binary encodings</span>
<a name="line-290"></a>  <span class="hs-comment">{- |
<a name="line-291"></a>There are many options for implementing a base-128 (i.e, 7-bit),
<a name="line-292"></a>variable-length encoding. The encoding implemented here is the one used by
<a name="line-293"></a>Google's protocol buffer library
<a name="line-294"></a>&lt;<a href="http://code.google.com/apis/protocolbuffers/docs/encoding.html#varints">http://code.google.com/apis/protocolbuffers/docs/encoding.html#varints</a>&gt;.  This
<a name="line-295"></a>encoding can be implemented efficiently and provides the desired property that
<a name="line-296"></a>small positive integers result in short sequences of bytes. It is intended to
<a name="line-297"></a>be used for the new default binary serialization format of the differently
<a name="line-298"></a>sized 'Word' types. It works as follows.
<a name="line-299"></a>
<a name="line-300"></a>The most-significant bit (MSB) of each output byte indicates whether
<a name="line-301"></a>there is a following byte (MSB set to 1) or it is the last byte (MSB set to 0).
<a name="line-302"></a>The remaining 7-bits are used to encode the input starting with the least
<a name="line-303"></a>significant 7-bit group of the input (i.e., a little-endian ordering of the
<a name="line-304"></a>7-bit groups is used).
<a name="line-305"></a>
<a name="line-306"></a>For example, the value @1 :: Int@ is encoded as @[0x01]@. The value
<a name="line-307"></a>@128 :: Int@, whose binary representation is @1000 0000@, is encoded as
<a name="line-308"></a>@[0x80, 0x01]@; i.e., the first byte has its MSB set and the least significant
<a name="line-309"></a>7-bit group is @000 0000@, the second byte has its MSB not set (it is the last
<a name="line-310"></a>byte) and its 7-bit group is @000 0001@.
<a name="line-311"></a>-}</span>
<a name="line-312"></a>    <span class="hs-varid">word8Var</span>
<a name="line-313"></a>  <span class="hs-layout">,</span> <span class="hs-varid">word16Var</span>
<a name="line-314"></a>  <span class="hs-layout">,</span> <span class="hs-varid">word32Var</span>
<a name="line-315"></a>  <span class="hs-layout">,</span> <span class="hs-varid">word64Var</span>
<a name="line-316"></a>  <span class="hs-layout">,</span> <span class="hs-varid">wordVar</span>
<a name="line-317"></a>
<a name="line-318"></a><span class="hs-comment">{- |
<a name="line-319"></a>The following encodings work by casting the signed integer to the equally sized
<a name="line-320"></a>unsigned integer. This works well for positive integers, but for negative
<a name="line-321"></a>integers it always results in the longest possible sequence of bytes,
<a name="line-322"></a>as their MSB is (by definition) always set.
<a name="line-323"></a>-}</span>
<a name="line-324"></a>
<a name="line-325"></a>  <span class="hs-layout">,</span> <span class="hs-varid">int8Var</span>
<a name="line-326"></a>  <span class="hs-layout">,</span> <span class="hs-varid">int16Var</span>
<a name="line-327"></a>  <span class="hs-layout">,</span> <span class="hs-varid">int32Var</span>
<a name="line-328"></a>  <span class="hs-layout">,</span> <span class="hs-varid">int64Var</span>
<a name="line-329"></a>  <span class="hs-layout">,</span> <span class="hs-varid">intVar</span>
<a name="line-330"></a>
<a name="line-331"></a><span class="hs-comment">{- |
<a name="line-332"></a>Positive and negative integers of small magnitude can be encoded compactly
<a name="line-333"></a>  using the so-called ZigZag encoding
<a name="line-334"></a>  (&lt;<a href="http://code.google.com/apis/protocolbuffers/docs/encoding.html#types">http://code.google.com/apis/protocolbuffers/docs/encoding.html#types</a>&gt;).
<a name="line-335"></a>The /ZigZag encoding/ uses
<a name="line-336"></a>  even numbers to encode the postive integers and
<a name="line-337"></a>  odd numbers to encode the negative integers.
<a name="line-338"></a>For example,
<a name="line-339"></a>  @0@ is encoded as @0@, @-1@ as @1@, @1@ as @2@, @-2@ as @3@, @2@ as @4@, and
<a name="line-340"></a>  so on.
<a name="line-341"></a>Its efficient implementation uses some bit-level magic.
<a name="line-342"></a>For example
<a name="line-343"></a>
<a name="line-344"></a>@
<a name="line-345"></a>zigZag32 :: 'Int32' -&gt; 'Word32'
<a name="line-346"></a>zigZag32 n = fromIntegral ((n \`shiftL\` 1) \`xor\` (n \`shiftR\` 31))
<a name="line-347"></a>@
<a name="line-348"></a>
<a name="line-349"></a>Note that the 'shiftR' is an arithmetic shift that performs sign extension.
<a name="line-350"></a>The ZigZag encoding essentially swaps the LSB with the MSB and additionally
<a name="line-351"></a>inverts all bits if the MSB is set.
<a name="line-352"></a>
<a name="line-353"></a>The following encodings implement the combintion of ZigZag encoding
<a name="line-354"></a>  together with the above base-128, variable length encodings.
<a name="line-355"></a>They are intended to become the the new default binary serialization format of
<a name="line-356"></a>  the differently sized 'Int' types.
<a name="line-357"></a>-}</span>
<a name="line-358"></a>  <span class="hs-layout">,</span> <span class="hs-varid">int8VarSigned</span>
<a name="line-359"></a>  <span class="hs-layout">,</span> <span class="hs-varid">int16VarSigned</span>
<a name="line-360"></a>  <span class="hs-layout">,</span> <span class="hs-varid">int32VarSigned</span>
<a name="line-361"></a>  <span class="hs-layout">,</span> <span class="hs-varid">int64VarSigned</span>
<a name="line-362"></a>  <span class="hs-layout">,</span> <span class="hs-varid">intVarSigned</span>
<a name="line-363"></a>
<a name="line-364"></a>
<a name="line-365"></a>  <span class="hs-comment">-- * Chunked / size-prefixed encodings</span>
<a name="line-366"></a><span class="hs-comment">{- |
<a name="line-367"></a>Some encodings like ASN.1 BER &lt;<a href="http://en.wikipedia.org/wiki/Basic_Encoding_Rules">http://en.wikipedia.org/wiki/Basic_Encoding_Rules</a>&gt;
<a name="line-368"></a>or Google's protocol buffers &lt;<a href="http://code.google.com/p/protobuf/">http://code.google.com/p/protobuf/</a>&gt; require
<a name="line-369"></a>encoded data to be prefixed with its length. The simple method to achieve this
<a name="line-370"></a>is to encode the data first into a separate buffer, compute the length of the
<a name="line-371"></a>encoded data, write it to the current output buffer, and append the separate
<a name="line-372"></a>buffers. The drawback of this method is that it requires a ...
<a name="line-373"></a>-}</span>
<a name="line-374"></a>  <span class="hs-layout">,</span> <span class="hs-varid">size</span>
<a name="line-375"></a>  <span class="hs-layout">,</span> <span class="hs-varid">sizeBound</span>
<a name="line-376"></a>  <span class="hs-comment">-- , withSizeFB</span>
<a name="line-377"></a>  <span class="hs-comment">-- , withSizeBB</span>
<a name="line-378"></a>  <span class="hs-layout">,</span> <span class="hs-varid">encodeWithSize</span>
<a name="line-379"></a>
<a name="line-380"></a>  <span class="hs-layout">,</span> <span class="hs-varid">encodeChunked</span>
<a name="line-381"></a>
<a name="line-382"></a>  <span class="hs-layout">,</span> <span class="hs-varid">wordVarFixedBound</span>
<a name="line-383"></a>  <span class="hs-layout">,</span> <span class="hs-varid">wordHexFixedBound</span>
<a name="line-384"></a>  <span class="hs-layout">,</span> <span class="hs-varid">wordDecFixedBound</span>
<a name="line-385"></a>
<a name="line-386"></a>  <span class="hs-layout">,</span> <span class="hs-varid">word64VarFixedBound</span>
<a name="line-387"></a>  <span class="hs-layout">,</span> <span class="hs-varid">word64HexFixedBound</span>
<a name="line-388"></a>  <span class="hs-layout">,</span> <span class="hs-varid">word64DecFixedBound</span>
<a name="line-389"></a>
<a name="line-390"></a>  <span class="hs-layout">)</span> <span class="hs-keyword">where</span>
<a name="line-391"></a>
<a name="line-392"></a><span class="hs-keyword">import</span>           <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">ByteString</span><span class="hs-varop">.</span><span class="hs-conid">Lazy</span><span class="hs-varop">.</span><span class="hs-conid">Builder</span><span class="hs-varop">.</span><span class="hs-conid">Internal</span>
<a name="line-393"></a><span class="hs-keyword">import</span>           <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">ByteString</span><span class="hs-varop">.</span><span class="hs-conid">Lazy</span><span class="hs-varop">.</span><span class="hs-conid">Builder</span><span class="hs-varop">.</span><span class="hs-conid">BasicEncoding</span><span class="hs-varop">.</span><span class="hs-conid">Internal</span><span class="hs-varop">.</span><span class="hs-conid">UncheckedShifts</span>
<a name="line-394"></a><span class="hs-keyword">import</span>           <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">ByteString</span><span class="hs-varop">.</span><span class="hs-conid">Lazy</span><span class="hs-varop">.</span><span class="hs-conid">Builder</span><span class="hs-varop">.</span><span class="hs-conid">BasicEncoding</span><span class="hs-varop">.</span><span class="hs-conid">Internal</span><span class="hs-varop">.</span><span class="hs-conid">Base16</span> <span class="hs-layout">(</span><span class="hs-varid">lowerTable</span><span class="hs-layout">,</span> <span class="hs-varid">encode4_as_8</span><span class="hs-layout">)</span>
<a name="line-395"></a>
<a name="line-396"></a><span class="hs-keyword">import</span> <span class="hs-keyword">qualified</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">ByteString</span>               <span class="hs-keyword">as</span> <span class="hs-conid">S</span>
<a name="line-397"></a><span class="hs-keyword">import</span> <span class="hs-keyword">qualified</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">ByteString</span><span class="hs-varop">.</span><span class="hs-conid">Internal</span>      <span class="hs-keyword">as</span> <span class="hs-conid">S</span>
<a name="line-398"></a><span class="hs-keyword">import</span> <span class="hs-keyword">qualified</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">ByteString</span><span class="hs-varop">.</span><span class="hs-conid">Lazy</span><span class="hs-varop">.</span><span class="hs-conid">Internal</span> <span class="hs-keyword">as</span> <span class="hs-conid">L</span>
<a name="line-399"></a>
<a name="line-400"></a><span class="hs-keyword">import</span>           <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Monoid</span>
<a name="line-401"></a><span class="hs-keyword">import</span>           <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">List</span> <span class="hs-layout">(</span><span class="hs-varid">unfoldr</span><span class="hs-layout">)</span>  <span class="hs-comment">-- HADDOCK ONLY</span>
<a name="line-402"></a><span class="hs-keyword">import</span>           <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">Char</span> <span class="hs-layout">(</span><span class="hs-varid">chr</span><span class="hs-layout">,</span> <span class="hs-varid">ord</span><span class="hs-layout">)</span>
<a name="line-403"></a><span class="hs-keyword">import</span>           <span class="hs-conid">Control</span><span class="hs-varop">.</span><span class="hs-conid">Monad</span> <span class="hs-layout">(</span><span class="hs-layout">(</span><span class="hs-varop">&lt;=&lt;</span><span class="hs-layout">)</span><span class="hs-layout">,</span> <span class="hs-varid">unless</span><span class="hs-layout">)</span>
<a name="line-404"></a>
<a name="line-405"></a><span class="hs-keyword">import</span>           <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">ByteString</span><span class="hs-varop">.</span><span class="hs-conid">Lazy</span><span class="hs-varop">.</span><span class="hs-conid">Builder</span><span class="hs-varop">.</span><span class="hs-conid">BasicEncoding</span><span class="hs-varop">.</span><span class="hs-conid">Internal</span> <span class="hs-varid">hiding</span> <span class="hs-layout">(</span><span class="hs-varid">size</span><span class="hs-layout">,</span> <span class="hs-varid">sizeBound</span><span class="hs-layout">)</span>
<a name="line-406"></a><span class="hs-keyword">import</span> <span class="hs-keyword">qualified</span> <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">ByteString</span><span class="hs-varop">.</span><span class="hs-conid">Lazy</span><span class="hs-varop">.</span><span class="hs-conid">Builder</span><span class="hs-varop">.</span><span class="hs-conid">BasicEncoding</span><span class="hs-varop">.</span><span class="hs-conid">Internal</span> <span class="hs-keyword">as</span> <span class="hs-conid">I</span> <span class="hs-layout">(</span><span class="hs-varid">size</span><span class="hs-layout">,</span> <span class="hs-varid">sizeBound</span><span class="hs-layout">)</span>
<a name="line-407"></a><span class="hs-keyword">import</span>           <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">ByteString</span><span class="hs-varop">.</span><span class="hs-conid">Lazy</span><span class="hs-varop">.</span><span class="hs-conid">Builder</span><span class="hs-varop">.</span><span class="hs-conid">BasicEncoding</span><span class="hs-varop">.</span><span class="hs-conid">Binary</span>
<a name="line-408"></a><span class="hs-keyword">import</span>           <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">ByteString</span><span class="hs-varop">.</span><span class="hs-conid">Lazy</span><span class="hs-varop">.</span><span class="hs-conid">Builder</span><span class="hs-varop">.</span><span class="hs-conid">BasicEncoding</span><span class="hs-varop">.</span><span class="hs-conid">ASCII</span>
<a name="line-409"></a><span class="hs-keyword">import</span>           <span class="hs-conid">Data</span><span class="hs-varop">.</span><span class="hs-conid">ByteString</span><span class="hs-varop">.</span><span class="hs-conid">Lazy</span><span class="hs-varop">.</span><span class="hs-conid">Builder</span><span class="hs-varop">.</span><span class="hs-conid">BasicEncoding</span>
<a name="line-410"></a>
<a name="line-411"></a><span class="hs-keyword">import</span>           <span class="hs-conid">Foreign</span>
<a name="line-412"></a>
<a name="line-413"></a><span class="hs-comment">------------------------------------------------------------------------------</span>
<a name="line-414"></a><span class="hs-comment">-- Adapting 'size' for the public interface.</span>
<a name="line-415"></a><span class="hs-comment">------------------------------------------------------------------------------</span>
<a name="line-416"></a>
<a name="line-417"></a><a name="size"></a><span class="hs-comment">-- | The size of the sequence of bytes generated by this 'FixedEncoding'.</span>
<a name="line-418"></a><span class="hs-definition">size</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Word</span>
<a name="line-419"></a><span class="hs-definition">size</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varop">.</span> <span class="hs-conid">I</span><span class="hs-varop">.</span><span class="hs-varid">size</span>
<a name="line-420"></a>
<a name="line-421"></a><a name="sizeBound"></a><span class="hs-comment">-- | The bound on the size of the sequence of bytes generated by this</span>
<a name="line-422"></a><span class="hs-comment">-- 'BoundedEncoding'.</span>
<a name="line-423"></a><span class="hs-definition">sizeBound</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Word</span>
<a name="line-424"></a><span class="hs-definition">sizeBound</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varop">.</span> <span class="hs-conid">I</span><span class="hs-varop">.</span><span class="hs-varid">sizeBound</span>
<a name="line-425"></a>
<a name="line-426"></a>
<a name="line-427"></a><span class="hs-comment">------------------------------------------------------------------------------</span>
<a name="line-428"></a><span class="hs-comment">-- Base-128 Variable-Length Encodings</span>
<a name="line-429"></a><span class="hs-comment">------------------------------------------------------------------------------</span>
<a name="line-430"></a>
<a name="line-431"></a><a name="encodeBase128"></a><span class="hs-comment">{-# INLINE encodeBase128 #-}</span>
<a name="line-432"></a><span class="hs-definition">encodeBase128</span>
<a name="line-433"></a>    <span class="hs-keyglyph">::</span> <span class="hs-keyword">forall</span> <span class="hs-varid">a</span> <span class="hs-varid">b</span><span class="hs-varop">.</span> <span class="hs-layout">(</span><span class="hs-conid">Integral</span> <span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-conid">Bits</span> <span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-conid">Storable</span> <span class="hs-varid">b</span><span class="hs-layout">,</span> <span class="hs-conid">Integral</span> <span class="hs-varid">b</span><span class="hs-layout">,</span> <span class="hs-conid">Num</span> <span class="hs-varid">b</span><span class="hs-layout">)</span>
<a name="line-434"></a>    <span class="hs-keyglyph">=&gt;</span> <span class="hs-layout">(</span><span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-varid">b</span>
<a name="line-435"></a><span class="hs-definition">encodeBase128</span> <span class="hs-varid">shiftr</span> <span class="hs-keyglyph">=</span>
<a name="line-436"></a>    <span class="hs-comment">-- We add 6 because we require the result of (`div` 7) to be rounded up.</span>
<a name="line-437"></a>    <span class="hs-varid">boundedEncoding</span> <span class="hs-layout">(</span><span class="hs-layout">(</span><span class="hs-num">8</span> <span class="hs-varop">*</span> <span class="hs-varid">sizeOf</span> <span class="hs-layout">(</span><span class="hs-varid">undefined</span> <span class="hs-keyglyph">::</span> <span class="hs-varid">b</span><span class="hs-layout">)</span> <span class="hs-varop">+</span> <span class="hs-num">6</span><span class="hs-layout">)</span> <span class="hs-varop">`div`</span> <span class="hs-num">7</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">io</span> <span class="hs-varop">.</span> <span class="hs-varid">fromIntegral</span><span class="hs-layout">)</span>
<a name="line-438"></a>  <span class="hs-keyword">where</span>
<a name="line-439"></a>    <span class="hs-varid">io</span> <span class="hs-varop">!</span><span class="hs-varid">x</span> <span class="hs-varop">!</span><span class="hs-varid">op</span>
<a name="line-440"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">x'</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>   <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span> <span class="hs-varid">poke8</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">.&amp;.</span> <span class="hs-num">0x7f</span><span class="hs-layout">)</span>
<a name="line-441"></a>                       <span class="hs-varid">return</span> <span class="hs-varop">$!</span> <span class="hs-varid">op</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-num">1</span>
<a name="line-442"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span> <span class="hs-varid">poke8</span> <span class="hs-layout">(</span><span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">.&amp;.</span> <span class="hs-num">0x7f</span><span class="hs-layout">)</span> <span class="hs-varop">.|.</span> <span class="hs-num">0x80</span><span class="hs-layout">)</span>
<a name="line-443"></a>                       <span class="hs-varid">io</span> <span class="hs-varid">x'</span> <span class="hs-layout">(</span><span class="hs-varid">op</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-num">1</span><span class="hs-layout">)</span>
<a name="line-444"></a>      <span class="hs-keyword">where</span>
<a name="line-445"></a>        <span class="hs-varid">x'</span>    <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">`shiftr`</span> <span class="hs-num">7</span>
<a name="line-446"></a>        <span class="hs-varid">poke8</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">poke</span> <span class="hs-varid">op</span> <span class="hs-varop">.</span> <span class="hs-varid">fromIntegral</span>
<a name="line-447"></a>
<a name="line-448"></a><a name="word8Var"></a><span class="hs-comment">-- | Base-128, variable length encoding of a 'Word8'.</span>
<a name="line-449"></a><span class="hs-comment">{-# INLINE word8Var #-}</span>
<a name="line-450"></a><span class="hs-definition">word8Var</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Word8</span>
<a name="line-451"></a><span class="hs-definition">word8Var</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">encodeBase128</span> <span class="hs-varid">shiftr_w</span>
<a name="line-452"></a>
<a name="line-453"></a><a name="word16Var"></a><span class="hs-comment">-- | Base-128, variable length encoding of a 'Word16'.</span>
<a name="line-454"></a><span class="hs-comment">{-# INLINE word16Var #-}</span>
<a name="line-455"></a><span class="hs-definition">word16Var</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Word16</span>
<a name="line-456"></a><span class="hs-definition">word16Var</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">encodeBase128</span> <span class="hs-varid">shiftr_w</span>
<a name="line-457"></a>
<a name="line-458"></a><a name="word32Var"></a><span class="hs-comment">-- | Base-128, variable length encoding of a 'Word32'.</span>
<a name="line-459"></a><span class="hs-comment">{-# INLINE word32Var #-}</span>
<a name="line-460"></a><span class="hs-definition">word32Var</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Word32</span>
<a name="line-461"></a><span class="hs-definition">word32Var</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">encodeBase128</span> <span class="hs-varid">shiftr_w32</span>
<a name="line-462"></a>
<a name="line-463"></a><a name="word64Var"></a><span class="hs-comment">-- | Base-128, variable length encoding of a 'Word64'.</span>
<a name="line-464"></a><span class="hs-comment">{-# INLINE word64Var #-}</span>
<a name="line-465"></a><span class="hs-definition">word64Var</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Word64</span>
<a name="line-466"></a><span class="hs-definition">word64Var</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">encodeBase128</span> <span class="hs-varid">shiftr_w64</span>
<a name="line-467"></a>
<a name="line-468"></a><a name="wordVar"></a><span class="hs-comment">-- | Base-128, variable length encoding of a 'Word'.</span>
<a name="line-469"></a><span class="hs-comment">{-# INLINE wordVar #-}</span>
<a name="line-470"></a><span class="hs-definition">wordVar</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Word</span>
<a name="line-471"></a><span class="hs-definition">wordVar</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">encodeBase128</span> <span class="hs-varid">shiftr_w</span>
<a name="line-472"></a>
<a name="line-473"></a>
<a name="line-474"></a><a name="int8Var"></a><span class="hs-comment">-- | Base-128, variable length encoding of an 'Int8'.</span>
<a name="line-475"></a><span class="hs-comment">-- Use 'int8VarSigned' for encoding negative numbers.</span>
<a name="line-476"></a><span class="hs-comment">{-# INLINE int8Var #-}</span>
<a name="line-477"></a><span class="hs-definition">int8Var</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Int8</span>
<a name="line-478"></a><span class="hs-definition">int8Var</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varop">&gt;$&lt;</span> <span class="hs-varid">word8Var</span>
<a name="line-479"></a>
<a name="line-480"></a><a name="int16Var"></a><span class="hs-comment">-- | Base-128, variable length encoding of an 'Int16'.</span>
<a name="line-481"></a><span class="hs-comment">-- Use 'int16VarSigned' for encoding negative numbers.</span>
<a name="line-482"></a><span class="hs-comment">{-# INLINE int16Var #-}</span>
<a name="line-483"></a><span class="hs-definition">int16Var</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Int16</span>
<a name="line-484"></a><span class="hs-definition">int16Var</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varop">&gt;$&lt;</span> <span class="hs-varid">word16Var</span>
<a name="line-485"></a>
<a name="line-486"></a><a name="int32Var"></a><span class="hs-comment">-- | Base-128, variable length encoding of an 'Int32'.</span>
<a name="line-487"></a><span class="hs-comment">-- Use 'int32VarSigned' for encoding negative numbers.</span>
<a name="line-488"></a><span class="hs-comment">{-# INLINE int32Var #-}</span>
<a name="line-489"></a><span class="hs-definition">int32Var</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Int32</span>
<a name="line-490"></a><span class="hs-definition">int32Var</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varop">&gt;$&lt;</span> <span class="hs-varid">word32Var</span>
<a name="line-491"></a>
<a name="line-492"></a><a name="int64Var"></a><span class="hs-comment">-- | Base-128, variable length encoding of an 'Int64'.</span>
<a name="line-493"></a><span class="hs-comment">-- Use 'int64VarSigned' for encoding negative numbers.</span>
<a name="line-494"></a><span class="hs-comment">{-# INLINE int64Var #-}</span>
<a name="line-495"></a><span class="hs-definition">int64Var</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Int64</span>
<a name="line-496"></a><span class="hs-definition">int64Var</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varop">&gt;$&lt;</span> <span class="hs-varid">word64Var</span>
<a name="line-497"></a>
<a name="line-498"></a><a name="intVar"></a><span class="hs-comment">-- | Base-128, variable length encoding of an 'Int'.</span>
<a name="line-499"></a><span class="hs-comment">-- Use 'intVarSigned' for encoding negative numbers.</span>
<a name="line-500"></a><span class="hs-comment">{-# INLINE intVar #-}</span>
<a name="line-501"></a><span class="hs-definition">intVar</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Int</span>
<a name="line-502"></a><span class="hs-definition">intVar</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varop">&gt;$&lt;</span> <span class="hs-varid">wordVar</span>
<a name="line-503"></a>
<a name="line-504"></a><a name="zigZag"></a><span class="hs-comment">{-# INLINE zigZag #-}</span>
<a name="line-505"></a><span class="hs-definition">zigZag</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">Storable</span> <span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-conid">Bits</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span>
<a name="line-506"></a><span class="hs-definition">zigZag</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">`shiftL`</span> <span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-varop">`xor`</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">`shiftR`</span> <span class="hs-layout">(</span><span class="hs-num">8</span> <span class="hs-varop">*</span> <span class="hs-varid">sizeOf</span> <span class="hs-varid">x</span> <span class="hs-comment">-</span> <span class="hs-num">1</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-507"></a>
<a name="line-508"></a><a name="int8VarSigned"></a><span class="hs-comment">-- | Base-128, variable length, ZigZag encoding of an 'Int'.</span>
<a name="line-509"></a><span class="hs-comment">{-# INLINE int8VarSigned #-}</span>
<a name="line-510"></a><span class="hs-definition">int8VarSigned</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Int8</span>
<a name="line-511"></a><span class="hs-definition">int8VarSigned</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">zigZag</span> <span class="hs-varop">&gt;$&lt;</span> <span class="hs-varid">int8Var</span>
<a name="line-512"></a>
<a name="line-513"></a><a name="int16VarSigned"></a><span class="hs-comment">-- | Base-128, variable length, ZigZag encoding of an 'Int16'.</span>
<a name="line-514"></a><span class="hs-comment">{-# INLINE int16VarSigned #-}</span>
<a name="line-515"></a><span class="hs-definition">int16VarSigned</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Int16</span>
<a name="line-516"></a><span class="hs-definition">int16VarSigned</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">zigZag</span> <span class="hs-varop">&gt;$&lt;</span> <span class="hs-varid">int16Var</span>
<a name="line-517"></a>
<a name="line-518"></a><a name="int32VarSigned"></a><span class="hs-comment">-- | Base-128, variable length, ZigZag encoding of an 'Int32'.</span>
<a name="line-519"></a><span class="hs-comment">{-# INLINE int32VarSigned #-}</span>
<a name="line-520"></a><span class="hs-definition">int32VarSigned</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Int32</span>
<a name="line-521"></a><span class="hs-definition">int32VarSigned</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">zigZag</span> <span class="hs-varop">&gt;$&lt;</span> <span class="hs-varid">int32Var</span>
<a name="line-522"></a>
<a name="line-523"></a><a name="int64VarSigned"></a><span class="hs-comment">-- | Base-128, variable length, ZigZag encoding of an 'Int64'.</span>
<a name="line-524"></a><span class="hs-comment">{-# INLINE int64VarSigned #-}</span>
<a name="line-525"></a><span class="hs-definition">int64VarSigned</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Int64</span>
<a name="line-526"></a><span class="hs-definition">int64VarSigned</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">zigZag</span> <span class="hs-varop">&gt;$&lt;</span> <span class="hs-varid">int64Var</span>
<a name="line-527"></a>
<a name="line-528"></a><a name="intVarSigned"></a><span class="hs-comment">-- | Base-128, variable length, ZigZag encoding of an 'Int'.</span>
<a name="line-529"></a><span class="hs-comment">{-# INLINE intVarSigned #-}</span>
<a name="line-530"></a><span class="hs-definition">intVarSigned</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Int</span>
<a name="line-531"></a><span class="hs-definition">intVarSigned</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">zigZag</span> <span class="hs-varop">&gt;$&lt;</span> <span class="hs-varid">intVar</span>
<a name="line-532"></a>
<a name="line-533"></a>
<a name="line-534"></a>
<a name="line-535"></a><span class="hs-comment">------------------------------------------------------------------------------</span>
<a name="line-536"></a><span class="hs-comment">-- Chunked Encoding Transformer</span>
<a name="line-537"></a><span class="hs-comment">------------------------------------------------------------------------------</span>
<a name="line-538"></a>
<a name="line-539"></a><a name="encodeChunked"></a><span class="hs-comment">-- | /Heavy inlining./</span>
<a name="line-540"></a><span class="hs-comment">{-# INLINE encodeChunked #-}</span>
<a name="line-541"></a><span class="hs-definition">encodeChunked</span>
<a name="line-542"></a>    <span class="hs-keyglyph">::</span> <span class="hs-conid">Word</span>                           <span class="hs-comment">-- ^ Minimal free-size</span>
<a name="line-543"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-conid">Word64</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-conid">Word64</span><span class="hs-layout">)</span>
<a name="line-544"></a>    <span class="hs-comment">-- ^ Given a sizeBound on the maximal encodable size this function must return</span>
<a name="line-545"></a>    <span class="hs-comment">-- a fixed-size encoding for encoding all smaller size.</span>
<a name="line-546"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Word64</span><span class="hs-layout">)</span>
<a name="line-547"></a>    <span class="hs-comment">-- ^ An encoding for terminating a chunk of the given size.</span>
<a name="line-548"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Builder</span>
<a name="line-549"></a>    <span class="hs-comment">-- ^ Inner Builder to transform</span>
<a name="line-550"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Builder</span>
<a name="line-551"></a>    <span class="hs-comment">-- ^ 'Put' with chunked encoding.</span>
<a name="line-552"></a><span class="hs-definition">encodeChunked</span> <span class="hs-varid">minFree</span> <span class="hs-varid">mkBeforeFE</span> <span class="hs-varid">afterBE</span> <span class="hs-keyglyph">=</span>
<a name="line-553"></a>    <span class="hs-varid">fromPut</span> <span class="hs-varop">.</span> <span class="hs-varid">putChunked</span> <span class="hs-varid">minFree</span> <span class="hs-varid">mkBeforeFE</span> <span class="hs-varid">afterBE</span> <span class="hs-varop">.</span> <span class="hs-varid">putBuilder</span>
<a name="line-554"></a>
<a name="line-555"></a><a name="putChunked"></a><span class="hs-comment">-- | /Heavy inlining./</span>
<a name="line-556"></a><span class="hs-comment">{-# INLINE putChunked #-}</span>
<a name="line-557"></a><span class="hs-definition">putChunked</span>
<a name="line-558"></a>    <span class="hs-keyglyph">::</span> <span class="hs-conid">Word</span>                         <span class="hs-comment">-- ^ Minimal free-size</span>
<a name="line-559"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-conid">Word64</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-conid">Word64</span><span class="hs-layout">)</span>
<a name="line-560"></a>    <span class="hs-comment">-- ^ Given a sizeBound on the maximal encodable size this function must return</span>
<a name="line-561"></a>    <span class="hs-comment">-- a fixed-size encoding for encoding all smaller size.</span>
<a name="line-562"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-conid">BoundedEncoding</span> <span class="hs-conid">Word64</span><span class="hs-layout">)</span>
<a name="line-563"></a>    <span class="hs-comment">-- ^ Encoding a directly inserted chunk.</span>
<a name="line-564"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Put</span> <span class="hs-varid">a</span>
<a name="line-565"></a>    <span class="hs-comment">-- ^ Inner Put to transform</span>
<a name="line-566"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Put</span> <span class="hs-varid">a</span>
<a name="line-567"></a>    <span class="hs-comment">-- ^ 'Put' with chunked encoding.</span>
<a name="line-568"></a><span class="hs-definition">putChunked</span> <span class="hs-varid">minFree0</span> <span class="hs-varid">mkBeforeFE</span> <span class="hs-varid">afterBE</span> <span class="hs-varid">p</span> <span class="hs-keyglyph">=</span>
<a name="line-569"></a>    <span class="hs-varid">put</span> <span class="hs-varid">encodingStep</span>
<a name="line-570"></a>  <span class="hs-keyword">where</span>
<a name="line-571"></a>    <span class="hs-varid">minFree</span><span class="hs-layout">,</span> <span class="hs-varid">reservedAfter</span><span class="hs-layout">,</span> <span class="hs-varid">maxReserved</span><span class="hs-layout">,</span> <span class="hs-varid">minBufferSize</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span>
<a name="line-572"></a>    <span class="hs-varid">minFree</span>       <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varop">$</span> <span class="hs-varid">max</span> <span class="hs-num">1</span> <span class="hs-varid">minFree0</span>   <span class="hs-comment">-- sanitize and convert to Int</span>
<a name="line-573"></a>
<a name="line-574"></a>    <span class="hs-comment">-- reserved space must be computed for maximum buffer size to cover for all</span>
<a name="line-575"></a>    <span class="hs-comment">-- sizes of the actually returned buffer.</span>
<a name="line-576"></a>    <span class="hs-varid">reservedAfter</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">I</span><span class="hs-varop">.</span><span class="hs-varid">sizeBound</span> <span class="hs-varid">afterBE</span>
<a name="line-577"></a>    <span class="hs-varid">maxReserved</span>   <span class="hs-keyglyph">=</span> <span class="hs-conid">I</span><span class="hs-varop">.</span><span class="hs-varid">size</span> <span class="hs-layout">(</span><span class="hs-varid">mkBeforeFE</span> <span class="hs-varid">maxBound</span><span class="hs-layout">)</span> <span class="hs-varop">+</span> <span class="hs-varid">reservedAfter</span>
<a name="line-578"></a>    <span class="hs-varid">minBufferSize</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">minFree</span> <span class="hs-varop">+</span> <span class="hs-varid">maxReserved</span>
<a name="line-579"></a>
<a name="line-580"></a>    <span class="hs-varid">encodingStep</span> <span class="hs-varid">k</span> <span class="hs-keyglyph">=</span>
<a name="line-581"></a>        <span class="hs-varid">fill</span> <span class="hs-layout">(</span><span class="hs-varid">runPut</span> <span class="hs-varid">p</span><span class="hs-layout">)</span>
<a name="line-582"></a>      <span class="hs-keyword">where</span>
<a name="line-583"></a>        <span class="hs-varid">fill</span> <span class="hs-varid">innerStep</span> <span class="hs-varop">!</span><span class="hs-layout">(</span><span class="hs-conid">BufferRange</span> <span class="hs-varid">op</span> <span class="hs-varid">ope</span><span class="hs-layout">)</span>
<a name="line-584"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">outRemaining</span> <span class="hs-varop">&lt;</span> <span class="hs-varid">minBufferSize</span> <span class="hs-keyglyph">=</span>
<a name="line-585"></a>              <span class="hs-varid">return</span> <span class="hs-varop">$!</span> <span class="hs-varid">bufferFull</span> <span class="hs-varid">minBufferSize</span> <span class="hs-varid">op</span> <span class="hs-layout">(</span><span class="hs-varid">fill</span> <span class="hs-varid">innerStep</span><span class="hs-layout">)</span>
<a name="line-586"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-587"></a>              <span class="hs-varid">fillWithBuildStep</span> <span class="hs-varid">innerStep</span> <span class="hs-varid">doneH</span> <span class="hs-varid">fullH</span> <span class="hs-varid">insertChunksH</span> <span class="hs-varid">brInner</span>
<a name="line-588"></a>          <span class="hs-keyword">where</span>
<a name="line-589"></a>            <span class="hs-varid">outRemaining</span>   <span class="hs-keyglyph">=</span> <span class="hs-varid">ope</span> <span class="hs-varop">`minusPtr`</span> <span class="hs-varid">op</span>
<a name="line-590"></a>            <span class="hs-varid">beforeFE</span>       <span class="hs-keyglyph">=</span> <span class="hs-varid">mkBeforeFE</span> <span class="hs-varop">$</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varid">outRemaining</span>
<a name="line-591"></a>            <span class="hs-varid">reservedBefore</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">I</span><span class="hs-varop">.</span><span class="hs-varid">size</span> <span class="hs-varid">beforeFE</span>
<a name="line-592"></a>
<a name="line-593"></a>            <span class="hs-varid">opInner</span>        <span class="hs-keyglyph">=</span> <span class="hs-varid">op</span>  <span class="hs-varop">`plusPtr`</span> <span class="hs-varid">reservedBefore</span>
<a name="line-594"></a>            <span class="hs-varid">opeInner</span>       <span class="hs-keyglyph">=</span> <span class="hs-varid">ope</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-varid">reservedAfter</span><span class="hs-layout">)</span>
<a name="line-595"></a>            <span class="hs-varid">brInner</span>        <span class="hs-keyglyph">=</span> <span class="hs-conid">BufferRange</span> <span class="hs-varid">opInner</span> <span class="hs-varid">opeInner</span>
<a name="line-596"></a>
<a name="line-597"></a>            <span class="hs-varid">wrapChunk</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Ptr</span> <span class="hs-conid">Word8</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">Ptr</span> <span class="hs-conid">Word8</span><span class="hs-layout">)</span>
<a name="line-598"></a>            <span class="hs-varid">wrapChunk</span> <span class="hs-varop">!</span><span class="hs-varid">opInner'</span>
<a name="line-599"></a>              <span class="hs-keyglyph">|</span> <span class="hs-varid">innerSize</span> <span class="hs-varop">==</span> <span class="hs-num">0</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">return</span> <span class="hs-varid">op</span> <span class="hs-comment">-- no data written =&gt; no chunk to wrap</span>
<a name="line-600"></a>              <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>      <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-601"></a>                  <span class="hs-varid">runF</span> <span class="hs-varid">beforeFE</span> <span class="hs-varid">innerSize</span> <span class="hs-varid">op</span>
<a name="line-602"></a>                  <span class="hs-varid">runB</span> <span class="hs-varid">afterBE</span> <span class="hs-varid">innerSize</span> <span class="hs-varid">opInner'</span>
<a name="line-603"></a>              <span class="hs-keyword">where</span>
<a name="line-604"></a>                <span class="hs-varid">innerSize</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varop">$</span> <span class="hs-varid">opInner'</span> <span class="hs-varop">`minusPtr`</span> <span class="hs-varid">opInner</span>
<a name="line-605"></a>
<a name="line-606"></a>            <span class="hs-varid">doneH</span> <span class="hs-varid">opInner'</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-607"></a>                <span class="hs-varid">op'</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">wrapChunk</span> <span class="hs-varid">opInner'</span>
<a name="line-608"></a>                <span class="hs-keyword">let</span> <span class="hs-varop">!</span><span class="hs-varid">br'</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">BufferRange</span> <span class="hs-varid">op'</span> <span class="hs-varid">ope</span>
<a name="line-609"></a>                <span class="hs-varid">k</span> <span class="hs-varid">x</span> <span class="hs-varid">br'</span>
<a name="line-610"></a>
<a name="line-611"></a>            <span class="hs-varid">fullH</span> <span class="hs-varid">opInner'</span> <span class="hs-varid">minSize</span> <span class="hs-varid">nextInnerStep</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-612"></a>                <span class="hs-varid">op'</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">wrapChunk</span> <span class="hs-varid">opInner'</span>
<a name="line-613"></a>                <span class="hs-varid">return</span> <span class="hs-varop">$!</span> <span class="hs-varid">bufferFull</span>
<a name="line-614"></a>                  <span class="hs-layout">(</span><span class="hs-varid">max</span> <span class="hs-varid">minBufferSize</span> <span class="hs-layout">(</span><span class="hs-varid">minSize</span> <span class="hs-varop">+</span> <span class="hs-varid">maxReserved</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-615"></a>                  <span class="hs-varid">op'</span>
<a name="line-616"></a>                  <span class="hs-layout">(</span><span class="hs-varid">fill</span> <span class="hs-varid">nextInnerStep</span><span class="hs-layout">)</span>
<a name="line-617"></a>
<a name="line-618"></a>            <span class="hs-varid">insertChunksH</span> <span class="hs-varid">opInner'</span> <span class="hs-varid">n</span> <span class="hs-varid">lbsC</span> <span class="hs-varid">nextInnerStep</span>
<a name="line-619"></a>              <span class="hs-keyglyph">|</span> <span class="hs-varid">n</span> <span class="hs-varop">==</span> <span class="hs-num">0</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>                      <span class="hs-comment">-- flush</span>
<a name="line-620"></a>                  <span class="hs-varid">op'</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">wrapChunk</span> <span class="hs-varid">opInner'</span>
<a name="line-621"></a>                  <span class="hs-varid">return</span> <span class="hs-varop">$!</span> <span class="hs-varid">insertChunks</span> <span class="hs-varid">op'</span> <span class="hs-num">0</span> <span class="hs-varid">id</span> <span class="hs-layout">(</span><span class="hs-varid">fill</span> <span class="hs-varid">nextInnerStep</span><span class="hs-layout">)</span>
<a name="line-622"></a>
<a name="line-623"></a>              <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>                   <span class="hs-comment">-- insert non-empty bytestring</span>
<a name="line-624"></a>                  <span class="hs-varid">op'</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">wrapChunk</span> <span class="hs-varid">opInner'</span>
<a name="line-625"></a>                  <span class="hs-keyword">let</span> <span class="hs-varop">!</span><span class="hs-varid">br'</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">BufferRange</span> <span class="hs-varid">op'</span> <span class="hs-varid">ope</span>
<a name="line-626"></a>                  <span class="hs-varid">runBuilderWith</span> <span class="hs-varid">chunkB</span> <span class="hs-layout">(</span><span class="hs-varid">fill</span> <span class="hs-varid">nextInnerStep</span><span class="hs-layout">)</span> <span class="hs-varid">br'</span>
<a name="line-627"></a>              <span class="hs-keyword">where</span>
<a name="line-628"></a>                <span class="hs-varid">nU</span>     <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varid">n</span>
<a name="line-629"></a>                <span class="hs-varid">chunkB</span> <span class="hs-keyglyph">=</span>
<a name="line-630"></a>                  <span class="hs-varid">encodeWithF</span> <span class="hs-layout">(</span><span class="hs-varid">mkBeforeFE</span> <span class="hs-varid">nU</span><span class="hs-layout">)</span> <span class="hs-varid">nU</span> <span class="hs-varop">`mappend`</span>
<a name="line-631"></a>                  <span class="hs-varid">lazyByteStringC</span> <span class="hs-varid">n</span> <span class="hs-varid">lbsC</span>         <span class="hs-varop">`mappend`</span>
<a name="line-632"></a>                  <span class="hs-varid">encodeWithB</span> <span class="hs-varid">afterBE</span> <span class="hs-varid">nU</span>
<a name="line-633"></a>
<a name="line-634"></a>
<a name="line-635"></a><a name="encodeWithSize"></a><span class="hs-comment">-- | /Heavy inlining./ Prefix a 'Builder' with the size of the</span>
<a name="line-636"></a><span class="hs-comment">-- sequence of bytes that it denotes.</span>
<a name="line-637"></a><span class="hs-comment">--</span>
<a name="line-638"></a><span class="hs-comment">-- This function is optimized for streaming use. It tries to prefix the size</span>
<a name="line-639"></a><span class="hs-comment">-- without copying the output. This is achieved by reserving space for the</span>
<a name="line-640"></a><span class="hs-comment">-- maximum size to be encoded. This succeeds if the output is smaller than</span>
<a name="line-641"></a><span class="hs-comment">-- the current free buffer size, which is guaranteed to be at least @8kb@.</span>
<a name="line-642"></a><span class="hs-comment">--</span>
<a name="line-643"></a><span class="hs-comment">-- If the output does not fit into the current free buffer size,</span>
<a name="line-644"></a><span class="hs-comment">-- the method falls back to encoding the data to a separate lazy bytestring,</span>
<a name="line-645"></a><span class="hs-comment">-- computing the size, and encoding the size before inserting the chunks of</span>
<a name="line-646"></a><span class="hs-comment">-- the separate lazy bytestring.</span>
<a name="line-647"></a><span class="hs-comment">{-# INLINE encodeWithSize #-}</span>
<a name="line-648"></a><span class="hs-definition">encodeWithSize</span>
<a name="line-649"></a>    <span class="hs-keyglyph">::</span>
<a name="line-650"></a>       <span class="hs-conid">Word</span>
<a name="line-651"></a>    <span class="hs-comment">-- ^ Inner buffer-size.</span>
<a name="line-652"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-conid">Word64</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-conid">Word64</span><span class="hs-layout">)</span>
<a name="line-653"></a>    <span class="hs-comment">-- ^ Given a bound on the maximal size to encode, this function must return</span>
<a name="line-654"></a>    <span class="hs-comment">-- a fixed-size encoding for all smaller sizes.</span>
<a name="line-655"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Builder</span>
<a name="line-656"></a>    <span class="hs-comment">-- ^ 'Put' to prefix with the length of its sequence of bytes.</span>
<a name="line-657"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Builder</span>
<a name="line-658"></a><span class="hs-definition">encodeWithSize</span> <span class="hs-varid">innerBufSize</span> <span class="hs-varid">mkSizeFE</span> <span class="hs-keyglyph">=</span>
<a name="line-659"></a>    <span class="hs-varid">fromPut</span> <span class="hs-varop">.</span> <span class="hs-varid">putWithSize</span> <span class="hs-varid">innerBufSize</span> <span class="hs-varid">mkSizeFE</span> <span class="hs-varop">.</span> <span class="hs-varid">putBuilder</span>
<a name="line-660"></a>
<a name="line-661"></a><a name="putWithSize"></a><span class="hs-comment">-- | Prefix a 'Put' with the size of its written data.</span>
<a name="line-662"></a><span class="hs-comment">{-# INLINE putWithSize #-}</span>
<a name="line-663"></a><span class="hs-definition">putWithSize</span>
<a name="line-664"></a>    <span class="hs-keyglyph">::</span> <span class="hs-keyword">forall</span> <span class="hs-varid">a</span><span class="hs-varop">.</span>
<a name="line-665"></a>       <span class="hs-conid">Word</span>
<a name="line-666"></a>    <span class="hs-comment">-- ^ Buffer-size for inner driver.</span>
<a name="line-667"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-layout">(</span><span class="hs-conid">Word64</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-conid">Word64</span><span class="hs-layout">)</span>
<a name="line-668"></a>    <span class="hs-comment">-- ^ Encoding the size for the fallback case.</span>
<a name="line-669"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Put</span> <span class="hs-varid">a</span>
<a name="line-670"></a>    <span class="hs-comment">-- ^ 'Put' to prefix with the length of its sequence of bytes.</span>
<a name="line-671"></a>    <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Put</span> <span class="hs-varid">a</span>
<a name="line-672"></a><span class="hs-definition">putWithSize</span> <span class="hs-varid">innerBufSize</span> <span class="hs-varid">mkSizeFE</span> <span class="hs-varid">innerP</span> <span class="hs-keyglyph">=</span>
<a name="line-673"></a>    <span class="hs-varid">put</span> <span class="hs-varop">$</span> <span class="hs-varid">encodingStep</span>
<a name="line-674"></a>  <span class="hs-keyword">where</span>
<a name="line-675"></a>    <span class="hs-comment">-- | The minimal free size is such that we can encode any size.</span>
<a name="line-676"></a>    <span class="hs-varid">minFree</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">I</span><span class="hs-varop">.</span><span class="hs-varid">size</span> <span class="hs-varop">$</span> <span class="hs-varid">mkSizeFE</span> <span class="hs-varid">maxBound</span>
<a name="line-677"></a>
<a name="line-678"></a>    <span class="hs-varid">encodingStep</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-keyword">forall</span> <span class="hs-varid">r</span><span class="hs-varop">.</span> <span class="hs-layout">(</span><span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">BuildStep</span> <span class="hs-varid">r</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">BuildStep</span> <span class="hs-varid">r</span><span class="hs-layout">)</span>
<a name="line-679"></a>    <span class="hs-varid">encodingStep</span> <span class="hs-varid">k</span> <span class="hs-keyglyph">=</span>
<a name="line-680"></a>        <span class="hs-varid">fill</span> <span class="hs-layout">(</span><span class="hs-varid">runPut</span> <span class="hs-varid">innerP</span><span class="hs-layout">)</span>
<a name="line-681"></a>      <span class="hs-keyword">where</span>
<a name="line-682"></a>        <span class="hs-varid">fill</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">BuildStep</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">BufferRange</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">BuildSignal</span> <span class="hs-varid">r</span><span class="hs-layout">)</span>
<a name="line-683"></a>        <span class="hs-varid">fill</span> <span class="hs-varid">innerStep</span> <span class="hs-varop">!</span><span class="hs-layout">(</span><span class="hs-conid">BufferRange</span> <span class="hs-varid">op</span> <span class="hs-varid">ope</span><span class="hs-layout">)</span>
<a name="line-684"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">outRemaining</span> <span class="hs-varop">&lt;</span> <span class="hs-varid">minFree</span> <span class="hs-keyglyph">=</span>
<a name="line-685"></a>              <span class="hs-varid">return</span> <span class="hs-varop">$!</span> <span class="hs-varid">bufferFull</span> <span class="hs-varid">minFree</span> <span class="hs-varid">op</span> <span class="hs-layout">(</span><span class="hs-varid">fill</span> <span class="hs-varid">innerStep</span><span class="hs-layout">)</span>
<a name="line-686"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-687"></a>              <span class="hs-varid">fillWithBuildStep</span> <span class="hs-varid">innerStep</span> <span class="hs-varid">doneH</span> <span class="hs-varid">fullH</span> <span class="hs-varid">insertChunksH</span> <span class="hs-varid">brInner</span>
<a name="line-688"></a>          <span class="hs-keyword">where</span>
<a name="line-689"></a>            <span class="hs-varid">outRemaining</span>   <span class="hs-keyglyph">=</span> <span class="hs-varid">ope</span> <span class="hs-varop">`minusPtr`</span> <span class="hs-varid">op</span>
<a name="line-690"></a>            <span class="hs-varid">sizeFE</span>         <span class="hs-keyglyph">=</span> <span class="hs-varid">mkSizeFE</span> <span class="hs-varop">$</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varid">outRemaining</span>
<a name="line-691"></a>            <span class="hs-varid">reservedBefore</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">I</span><span class="hs-varop">.</span><span class="hs-varid">size</span> <span class="hs-varid">sizeFE</span>
<a name="line-692"></a>            <span class="hs-varid">reservedAfter</span>  <span class="hs-keyglyph">=</span> <span class="hs-varid">minFree</span> <span class="hs-comment">-</span> <span class="hs-varid">reservedBefore</span>
<a name="line-693"></a>
<a name="line-694"></a>            <span class="hs-comment">-- leave enough free space such that all sizes can be encodded.</span>
<a name="line-695"></a>            <span class="hs-varid">startInner</span>    <span class="hs-keyglyph">=</span> <span class="hs-varid">op</span>  <span class="hs-varop">`plusPtr`</span> <span class="hs-varid">reservedBefore</span>
<a name="line-696"></a>            <span class="hs-varid">opeInner</span>      <span class="hs-keyglyph">=</span> <span class="hs-varid">ope</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-layout">(</span><span class="hs-varid">negate</span> <span class="hs-varid">reservedAfter</span><span class="hs-layout">)</span>
<a name="line-697"></a>            <span class="hs-varid">brInner</span>       <span class="hs-keyglyph">=</span> <span class="hs-conid">BufferRange</span> <span class="hs-varid">startInner</span> <span class="hs-varid">opeInner</span>
<a name="line-698"></a>
<a name="line-699"></a>            <span class="hs-varid">fastPrefixSize</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Ptr</span> <span class="hs-conid">Word8</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">Ptr</span> <span class="hs-conid">Word8</span><span class="hs-layout">)</span>
<a name="line-700"></a>            <span class="hs-varid">fastPrefixSize</span> <span class="hs-varop">!</span><span class="hs-varid">opInner'</span>
<a name="line-701"></a>              <span class="hs-keyglyph">|</span> <span class="hs-varid">innerSize</span> <span class="hs-varop">==</span> <span class="hs-num">0</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span> <span class="hs-varid">runB</span> <span class="hs-layout">(</span><span class="hs-varid">toB</span> <span class="hs-varop">$</span> <span class="hs-varid">mkSizeFE</span> <span class="hs-num">0</span><span class="hs-layout">)</span> <span class="hs-num">0</span>         <span class="hs-varid">op</span>
<a name="line-702"></a>              <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>      <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span> <span class="hs-varid">runF</span> <span class="hs-layout">(</span><span class="hs-varid">sizeFE</span><span class="hs-layout">)</span>           <span class="hs-varid">innerSize</span> <span class="hs-varid">op</span>
<a name="line-703"></a>                                    <span class="hs-varid">return</span> <span class="hs-varid">opInner'</span>
<a name="line-704"></a>              <span class="hs-keyword">where</span>
<a name="line-705"></a>                <span class="hs-varid">innerSize</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varop">$</span> <span class="hs-varid">opInner'</span> <span class="hs-varop">`minusPtr`</span> <span class="hs-varid">startInner</span>
<a name="line-706"></a>
<a name="line-707"></a>            <span class="hs-varid">slowPrefixSize</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Ptr</span> <span class="hs-conid">Word8</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Builder</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">BuildStep</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">BuildSignal</span> <span class="hs-varid">r</span><span class="hs-layout">)</span>
<a name="line-708"></a>            <span class="hs-varid">slowPrefixSize</span> <span class="hs-varid">opInner'</span> <span class="hs-varid">bInner</span> <span class="hs-varid">nextStep</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-709"></a>                <span class="hs-layout">(</span><span class="hs-varid">x</span><span class="hs-layout">,</span> <span class="hs-varid">chunks</span><span class="hs-layout">,</span> <span class="hs-varid">payLenChunks</span><span class="hs-layout">)</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">toLBS</span> <span class="hs-varop">$</span> <span class="hs-varid">runBuilderWith</span> <span class="hs-varid">bInner</span> <span class="hs-varid">nextStep</span>
<a name="line-710"></a>
<a name="line-711"></a>                <span class="hs-keyword">let</span> <span class="hs-comment">-- length of payload data in current buffer</span>
<a name="line-712"></a>                    <span class="hs-varid">payLenCur</span>   <span class="hs-keyglyph">=</span> <span class="hs-varid">opInner'</span> <span class="hs-varop">`minusPtr`</span> <span class="hs-varid">startInner</span>
<a name="line-713"></a>                    <span class="hs-comment">-- length of whole payload</span>
<a name="line-714"></a>                    <span class="hs-varid">payLen</span>      <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varid">payLenCur</span> <span class="hs-varop">+</span> <span class="hs-varid">fromIntegral</span> <span class="hs-varid">payLenChunks</span>
<a name="line-715"></a>                    <span class="hs-comment">-- encoder for payload length</span>
<a name="line-716"></a>                    <span class="hs-varid">sizeFE'</span>     <span class="hs-keyglyph">=</span> <span class="hs-varid">mkSizeFE</span> <span class="hs-varid">payLen</span>
<a name="line-717"></a>                    <span class="hs-comment">-- start of payload in current buffer with the payload</span>
<a name="line-718"></a>                    <span class="hs-comment">-- length encoded before</span>
<a name="line-719"></a>                    <span class="hs-varid">startInner'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">op</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-conid">I</span><span class="hs-varop">.</span><span class="hs-varid">size</span> <span class="hs-varid">sizeFE'</span>
<a name="line-720"></a>
<a name="line-721"></a>                <span class="hs-comment">-- move data in current buffer out of the way, if required</span>
<a name="line-722"></a>                <span class="hs-varid">unless</span> <span class="hs-layout">(</span><span class="hs-varid">startInner</span> <span class="hs-varop">==</span> <span class="hs-varid">startInner'</span><span class="hs-layout">)</span> <span class="hs-varop">$</span>
<a name="line-723"></a>                    <span class="hs-varid">moveBytes</span> <span class="hs-varid">startInner'</span> <span class="hs-varid">startInner</span> <span class="hs-varid">payLenCur</span>
<a name="line-724"></a>                <span class="hs-comment">-- encode payload length at start of the buffer</span>
<a name="line-725"></a>                <span class="hs-varid">runF</span> <span class="hs-varid">sizeFE'</span> <span class="hs-varid">payLen</span> <span class="hs-varid">op</span>
<a name="line-726"></a>                <span class="hs-comment">-- TODO: If we were to change the CIOS definition such that it also</span>
<a name="line-727"></a>                <span class="hs-comment">-- returns the last buffer for writing, we could also fill the</span>
<a name="line-728"></a>                <span class="hs-comment">-- last buffer with 'k' and return the signal, once it is</span>
<a name="line-729"></a>                <span class="hs-comment">-- filled, therefore avoiding unfilled space.</span>
<a name="line-730"></a>                <span class="hs-varid">return</span> <span class="hs-varop">$</span> <span class="hs-varid">insertChunks</span> <span class="hs-layout">(</span><span class="hs-varid">startInner'</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-varid">payLenCur</span><span class="hs-layout">)</span>
<a name="line-731"></a>                                      <span class="hs-varid">payLenChunks</span>
<a name="line-732"></a>                                      <span class="hs-varid">chunks</span>
<a name="line-733"></a>                                      <span class="hs-layout">(</span><span class="hs-varid">k</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-734"></a>              <span class="hs-keyword">where</span>
<a name="line-735"></a>                <span class="hs-varid">toLBS</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">runCIOSWithLength</span> <span class="hs-varop">&lt;=&lt;</span>
<a name="line-736"></a>                    <span class="hs-varid">buildStepToCIOSUntrimmedWith</span> <span class="hs-layout">(</span><span class="hs-varid">fromIntegral</span> <span class="hs-varid">innerBufSize</span><span class="hs-layout">)</span>
<a name="line-737"></a>
<a name="line-738"></a>            <span class="hs-varid">doneH</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Ptr</span> <span class="hs-conid">Word8</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">BuildSignal</span> <span class="hs-varid">r</span><span class="hs-layout">)</span>
<a name="line-739"></a>            <span class="hs-varid">doneH</span> <span class="hs-varid">opInner'</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-740"></a>                <span class="hs-varid">op'</span> <span class="hs-keyglyph">&lt;-</span> <span class="hs-varid">fastPrefixSize</span> <span class="hs-varid">opInner'</span>
<a name="line-741"></a>                <span class="hs-keyword">let</span> <span class="hs-varop">!</span><span class="hs-varid">br'</span> <span class="hs-keyglyph">=</span> <span class="hs-conid">BufferRange</span> <span class="hs-varid">op'</span> <span class="hs-varid">ope</span>
<a name="line-742"></a>                <span class="hs-varid">k</span> <span class="hs-varid">x</span> <span class="hs-varid">br'</span>
<a name="line-743"></a>
<a name="line-744"></a>            <span class="hs-varid">fullH</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Ptr</span> <span class="hs-conid">Word8</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">BuildStep</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">BuildSignal</span> <span class="hs-varid">r</span><span class="hs-layout">)</span>
<a name="line-745"></a>            <span class="hs-varid">fullH</span> <span class="hs-varid">opInner'</span> <span class="hs-varid">minSize</span> <span class="hs-varid">nextInnerStep</span> <span class="hs-keyglyph">=</span>
<a name="line-746"></a>                <span class="hs-varid">slowPrefixSize</span> <span class="hs-varid">opInner'</span> <span class="hs-layout">(</span><span class="hs-varid">ensureFree</span> <span class="hs-varid">minSize</span><span class="hs-layout">)</span> <span class="hs-varid">nextInnerStep</span>
<a name="line-747"></a>
<a name="line-748"></a>            <span class="hs-varid">insertChunksH</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Ptr</span> <span class="hs-conid">Word8</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int64</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">LazyByteStringC</span>
<a name="line-749"></a>                          <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">BuildStep</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">BuildSignal</span> <span class="hs-varid">r</span><span class="hs-layout">)</span>
<a name="line-750"></a>            <span class="hs-varid">insertChunksH</span> <span class="hs-varid">opInner'</span> <span class="hs-varid">n</span> <span class="hs-varid">lbsC</span> <span class="hs-varid">nextInnerStep</span> <span class="hs-keyglyph">=</span>
<a name="line-751"></a>                <span class="hs-varid">slowPrefixSize</span> <span class="hs-varid">opInner'</span> <span class="hs-layout">(</span><span class="hs-varid">lazyByteStringC</span> <span class="hs-varid">n</span> <span class="hs-varid">lbsC</span><span class="hs-layout">)</span> <span class="hs-varid">nextInnerStep</span>
<a name="line-752"></a>
<a name="line-753"></a>
<a name="line-754"></a><a name="runCIOSWithLength"></a><span class="hs-comment">-- | Run a 'ChunkIOStream' and gather its results and their length.</span>
<a name="line-755"></a><span class="hs-definition">runCIOSWithLength</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">ChunkIOStream</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-conid">LazyByteStringC</span><span class="hs-layout">,</span> <span class="hs-conid">Int64</span><span class="hs-layout">)</span>
<a name="line-756"></a><span class="hs-definition">runCIOSWithLength</span> <span class="hs-keyglyph">=</span>
<a name="line-757"></a>    <span class="hs-varid">go</span> <span class="hs-num">0</span> <span class="hs-varid">id</span>
<a name="line-758"></a>  <span class="hs-keyword">where</span>
<a name="line-759"></a>    <span class="hs-varid">go</span> <span class="hs-varop">!</span><span class="hs-varid">l</span> <span class="hs-varid">lbsC</span> <span class="hs-layout">(</span><span class="hs-conid">Finished</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>        <span class="hs-keyglyph">=</span> <span class="hs-varid">return</span> <span class="hs-layout">(</span><span class="hs-varid">x</span><span class="hs-layout">,</span> <span class="hs-varid">lbsC</span><span class="hs-layout">,</span> <span class="hs-varid">l</span><span class="hs-layout">)</span>
<a name="line-760"></a>    <span class="hs-varid">go</span> <span class="hs-varop">!</span><span class="hs-varid">l</span> <span class="hs-varid">lbsC</span> <span class="hs-layout">(</span><span class="hs-conid">YieldC</span> <span class="hs-varid">n</span> <span class="hs-varid">lbsC'</span> <span class="hs-varid">io</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">io</span> <span class="hs-varop">&gt;&gt;=</span> <span class="hs-varid">go</span> <span class="hs-layout">(</span><span class="hs-varid">l</span> <span class="hs-varop">+</span> <span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">lbsC</span> <span class="hs-varop">.</span> <span class="hs-varid">lbsC'</span><span class="hs-layout">)</span>
<a name="line-761"></a>    <span class="hs-varid">go</span> <span class="hs-varop">!</span><span class="hs-varid">l</span> <span class="hs-varid">lbsC</span> <span class="hs-layout">(</span><span class="hs-conid">Yield1</span> <span class="hs-varid">bs</span> <span class="hs-varid">io</span><span class="hs-layout">)</span>      <span class="hs-keyglyph">=</span>
<a name="line-762"></a>        <span class="hs-varid">io</span> <span class="hs-varop">&gt;&gt;=</span> <span class="hs-varid">go</span> <span class="hs-layout">(</span><span class="hs-varid">l</span> <span class="hs-varop">+</span> <span class="hs-varid">fromIntegral</span> <span class="hs-layout">(</span><span class="hs-conid">S</span><span class="hs-varop">.</span><span class="hs-varid">length</span> <span class="hs-varid">bs</span><span class="hs-layout">)</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">lbsC</span> <span class="hs-varop">.</span> <span class="hs-conid">L</span><span class="hs-varop">.</span><span class="hs-conid">Chunk</span> <span class="hs-varid">bs</span><span class="hs-layout">)</span>
<a name="line-763"></a>
<a name="line-764"></a><a name="buildStepToCIOSUntrimmedWith"></a><span class="hs-comment">-- | Run a 'BuildStep' using the untrimmed strategy.</span>
<a name="line-765"></a><span class="hs-definition">buildStepToCIOSUntrimmedWith</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">BuildStep</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">IO</span> <span class="hs-layout">(</span><span class="hs-conid">ChunkIOStream</span> <span class="hs-varid">a</span><span class="hs-layout">)</span>
<a name="line-766"></a><span class="hs-definition">buildStepToCIOSUntrimmedWith</span> <span class="hs-varid">bufSize</span> <span class="hs-keyglyph">=</span>
<a name="line-767"></a>    <span class="hs-varid">buildStepToCIOS</span> <span class="hs-layout">(</span><span class="hs-varid">untrimmedStrategy</span> <span class="hs-varid">bufSize</span> <span class="hs-varid">bufSize</span><span class="hs-layout">)</span>
<a name="line-768"></a>                    <span class="hs-layout">(</span><span class="hs-varid">return</span> <span class="hs-varop">.</span> <span class="hs-conid">Finished</span><span class="hs-layout">)</span>
<a name="line-769"></a>
<a name="line-770"></a>
<a name="line-771"></a><span class="hs-comment">----------------------------------------------------------------------</span>
<a name="line-772"></a><span class="hs-comment">-- Padded versions of encodings for streamed prefixing of output sizes</span>
<a name="line-773"></a><span class="hs-comment">----------------------------------------------------------------------</span>
<a name="line-774"></a>
<a name="line-775"></a><a name="appsUntilZero"></a><span class="hs-comment">{-# INLINE appsUntilZero #-}</span>
<a name="line-776"></a><span class="hs-definition">appsUntilZero</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">Eq</span> <span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-conid">Num</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">=&gt;</span> <span class="hs-layout">(</span><span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span>
<a name="line-777"></a><span class="hs-definition">appsUntilZero</span> <span class="hs-varid">f</span> <span class="hs-varid">x0</span> <span class="hs-keyglyph">=</span>
<a name="line-778"></a>    <span class="hs-varid">count</span> <span class="hs-num">0</span> <span class="hs-varid">x0</span>
<a name="line-779"></a>  <span class="hs-keyword">where</span>
<a name="line-780"></a>    <span class="hs-varid">count</span> <span class="hs-varop">!</span><span class="hs-varid">n</span> <span class="hs-num">0</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">n</span>
<a name="line-781"></a>    <span class="hs-varid">count</span> <span class="hs-varop">!</span><span class="hs-varid">n</span> <span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">count</span> <span class="hs-layout">(</span><span class="hs-varid">succ</span> <span class="hs-varid">n</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">f</span> <span class="hs-varid">x</span><span class="hs-layout">)</span>
<a name="line-782"></a>
<a name="line-783"></a>
<a name="line-784"></a><a name="genericVarFixedBound"></a><span class="hs-comment">{-# INLINE genericVarFixedBound #-}</span>
<a name="line-785"></a><span class="hs-definition">genericVarFixedBound</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">Eq</span> <span class="hs-varid">b</span><span class="hs-layout">,</span> <span class="hs-conid">Show</span> <span class="hs-varid">b</span><span class="hs-layout">,</span> <span class="hs-conid">Bits</span> <span class="hs-varid">b</span><span class="hs-layout">,</span> <span class="hs-conid">Num</span> <span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-conid">Integral</span> <span class="hs-varid">b</span><span class="hs-layout">)</span>
<a name="line-786"></a>                <span class="hs-keyglyph">=&gt;</span> <span class="hs-layout">(</span><span class="hs-varid">b</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">b</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">b</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-varid">b</span>
<a name="line-787"></a><span class="hs-definition">genericVarFixedBound</span> <span class="hs-varid">shiftRight</span> <span class="hs-varid">bound</span> <span class="hs-keyglyph">=</span>
<a name="line-788"></a>    <span class="hs-varid">fixedEncoding</span> <span class="hs-varid">n0</span> <span class="hs-varid">io</span>
<a name="line-789"></a>  <span class="hs-keyword">where</span>
<a name="line-790"></a>    <span class="hs-varid">n0</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">max</span> <span class="hs-num">1</span> <span class="hs-varop">$</span> <span class="hs-varid">appsUntilZero</span> <span class="hs-layout">(</span><span class="hs-varop">`shiftRight`</span> <span class="hs-num">7</span><span class="hs-layout">)</span> <span class="hs-varid">bound</span>
<a name="line-791"></a>
<a name="line-792"></a>    <span class="hs-varid">io</span> <span class="hs-varop">!</span><span class="hs-varid">x0</span> <span class="hs-varop">!</span><span class="hs-varid">op</span>
<a name="line-793"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">x0</span> <span class="hs-varop">&gt;</span> <span class="hs-varid">bound</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">error</span> <span class="hs-varid">err</span>
<a name="line-794"></a>      <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>  <span class="hs-keyglyph">=</span> <span class="hs-varid">loop</span> <span class="hs-num">0</span> <span class="hs-varid">x0</span>
<a name="line-795"></a>      <span class="hs-keyword">where</span>
<a name="line-796"></a>        <span class="hs-varid">err</span> <span class="hs-keyglyph">=</span> <span class="hs-str">&quot;genericVarFixedBound: value &quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">show</span> <span class="hs-varid">x0</span> <span class="hs-varop">++</span> <span class="hs-str">&quot; &gt; bound &quot;</span> <span class="hs-varop">++</span> <span class="hs-varid">show</span> <span class="hs-varid">bound</span>
<a name="line-797"></a>        <span class="hs-varid">loop</span> <span class="hs-varop">!</span><span class="hs-varid">n</span> <span class="hs-varop">!</span><span class="hs-varid">x</span>
<a name="line-798"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">n0</span> <span class="hs-varop">&lt;=</span> <span class="hs-varid">n</span> <span class="hs-varop">+</span> <span class="hs-num">1</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span> <span class="hs-varid">poke8</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">.&amp;.</span> <span class="hs-num">0x7f</span><span class="hs-layout">)</span>
<a name="line-799"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span>   <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span> <span class="hs-varid">poke8</span> <span class="hs-layout">(</span><span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">.&amp;.</span> <span class="hs-num">0x7f</span><span class="hs-layout">)</span> <span class="hs-varop">.|.</span> <span class="hs-num">0x80</span><span class="hs-layout">)</span>
<a name="line-800"></a>                             <span class="hs-varid">loop</span> <span class="hs-layout">(</span><span class="hs-varid">n</span> <span class="hs-varop">+</span> <span class="hs-num">1</span><span class="hs-layout">)</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-varop">`shiftRight`</span> <span class="hs-num">7</span><span class="hs-layout">)</span>
<a name="line-801"></a>          <span class="hs-keyword">where</span>
<a name="line-802"></a>            <span class="hs-varid">poke8</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">pokeElemOff</span> <span class="hs-varid">op</span> <span class="hs-varid">n</span> <span class="hs-varop">.</span> <span class="hs-varid">fromIntegral</span>
<a name="line-803"></a>
<a name="line-804"></a><a name="wordVarFixedBound"></a><span class="hs-comment">{-# INLINE wordVarFixedBound #-}</span>
<a name="line-805"></a><span class="hs-definition">wordVarFixedBound</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Word</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-conid">Word</span>
<a name="line-806"></a><span class="hs-definition">wordVarFixedBound</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">genericVarFixedBound</span> <span class="hs-varid">shiftr_w</span>
<a name="line-807"></a>
<a name="line-808"></a><a name="word64VarFixedBound"></a><span class="hs-comment">{-# INLINE word64VarFixedBound #-}</span>
<a name="line-809"></a><span class="hs-definition">word64VarFixedBound</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Word64</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-conid">Word64</span>
<a name="line-810"></a><span class="hs-definition">word64VarFixedBound</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">genericVarFixedBound</span> <span class="hs-varid">shiftr_w64</span>
<a name="line-811"></a>
<a name="line-812"></a>
<a name="line-813"></a><span class="hs-comment">-- Somehow this function doesn't really make sense, as the bound must be</span>
<a name="line-814"></a><span class="hs-comment">-- greater when interpreted as an unsigned integer. These conversions and</span>
<a name="line-815"></a><span class="hs-comment">-- decisions should be left to the user.</span>
<a name="line-816"></a><span class="hs-comment">--</span>
<a name="line-817"></a><span class="hs-comment">--{-# INLINE intVarFixed #-}</span>
<a name="line-818"></a><span class="hs-comment">--intVarFixed :: Size -&gt; FixedEncoding Size</span>
<a name="line-819"></a><span class="hs-comment">--intVarFixed bound = fromIntegral &gt;$&lt; wordVarFixed (fromIntegral bound)</span>
<a name="line-820"></a>
<a name="line-821"></a><a name="genHexFixedBound"></a><span class="hs-comment">{-# INLINE genHexFixedBound #-}</span>
<a name="line-822"></a><span class="hs-definition">genHexFixedBound</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">Num</span> <span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-conid">Bits</span> <span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-conid">Integral</span> <span class="hs-varid">a</span><span class="hs-layout">)</span>
<a name="line-823"></a>                 <span class="hs-keyglyph">=&gt;</span> <span class="hs-layout">(</span><span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Int</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span><span class="hs-layout">)</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Char</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-varid">a</span>
<a name="line-824"></a><span class="hs-definition">genHexFixedBound</span> <span class="hs-varid">shiftr</span> <span class="hs-varid">padding0</span> <span class="hs-varid">bound</span> <span class="hs-keyglyph">=</span>
<a name="line-825"></a>    <span class="hs-varid">fixedEncoding</span> <span class="hs-varid">n0</span> <span class="hs-varid">io</span>
<a name="line-826"></a>  <span class="hs-keyword">where</span>
<a name="line-827"></a>    <span class="hs-varid">n0</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">max</span> <span class="hs-num">1</span> <span class="hs-varop">$</span> <span class="hs-varid">appsUntilZero</span> <span class="hs-layout">(</span><span class="hs-varop">`shiftr`</span> <span class="hs-num">4</span><span class="hs-layout">)</span> <span class="hs-varid">bound</span>
<a name="line-828"></a>
<a name="line-829"></a>    <span class="hs-varid">padding</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-layout">(</span><span class="hs-varid">ord</span> <span class="hs-varid">padding0</span><span class="hs-layout">)</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Word8</span>
<a name="line-830"></a>
<a name="line-831"></a>    <span class="hs-varid">io</span> <span class="hs-varop">!</span><span class="hs-varid">x0</span> <span class="hs-varop">!</span><span class="hs-varid">op0</span> <span class="hs-keyglyph">=</span>
<a name="line-832"></a>        <span class="hs-varid">loop</span> <span class="hs-layout">(</span><span class="hs-varid">op0</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-varid">n0</span><span class="hs-layout">)</span> <span class="hs-varid">x0</span>
<a name="line-833"></a>      <span class="hs-keyword">where</span>
<a name="line-834"></a>        <span class="hs-varid">loop</span> <span class="hs-varop">!</span><span class="hs-varid">op</span> <span class="hs-varop">!</span><span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-835"></a>           <span class="hs-keyword">let</span> <span class="hs-varop">!</span><span class="hs-varid">op'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">op</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span>
<a name="line-836"></a>           <span class="hs-varid">poke</span> <span class="hs-varid">op'</span> <span class="hs-varop">=&lt;&lt;</span> <span class="hs-varid">encode4_as_8</span> <span class="hs-varid">lowerTable</span> <span class="hs-layout">(</span><span class="hs-varid">fromIntegral</span> <span class="hs-varop">$</span> <span class="hs-varid">x</span> <span class="hs-varop">.&amp;.</span> <span class="hs-num">0xf</span><span class="hs-layout">)</span>
<a name="line-837"></a>           <span class="hs-keyword">let</span> <span class="hs-varop">!</span><span class="hs-varid">x'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">`shiftr`</span> <span class="hs-num">4</span>
<a name="line-838"></a>           <span class="hs-varid">unless</span> <span class="hs-layout">(</span><span class="hs-varid">op'</span> <span class="hs-varop">&lt;=</span> <span class="hs-varid">op0</span><span class="hs-layout">)</span> <span class="hs-varop">$</span>
<a name="line-839"></a>             <span class="hs-keyword">if</span> <span class="hs-varid">x'</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>
<a name="line-840"></a>               <span class="hs-keyword">then</span> <span class="hs-varid">pad</span> <span class="hs-layout">(</span><span class="hs-varid">op'</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-841"></a>               <span class="hs-keyword">else</span> <span class="hs-varid">loop</span> <span class="hs-varid">op'</span> <span class="hs-varid">x'</span>
<a name="line-842"></a>
<a name="line-843"></a>        <span class="hs-varid">pad</span> <span class="hs-varop">!</span><span class="hs-varid">op</span>
<a name="line-844"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">op</span> <span class="hs-varop">&lt;</span> <span class="hs-varid">op0</span>  <span class="hs-keyglyph">=</span> <span class="hs-varid">return</span> <span class="hs-conid">()</span>
<a name="line-845"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">poke</span> <span class="hs-varid">op</span> <span class="hs-varid">padding</span> <span class="hs-varop">&gt;&gt;</span> <span class="hs-varid">pad</span> <span class="hs-layout">(</span><span class="hs-varid">op</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-846"></a>
<a name="line-847"></a>
<a name="line-848"></a><a name="wordHexFixedBound"></a><span class="hs-comment">{-# INLINE wordHexFixedBound #-}</span>
<a name="line-849"></a><span class="hs-definition">wordHexFixedBound</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Char</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Word</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-conid">Word</span>
<a name="line-850"></a><span class="hs-definition">wordHexFixedBound</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">genHexFixedBound</span> <span class="hs-varid">shiftr_w</span>
<a name="line-851"></a>
<a name="line-852"></a><a name="word64HexFixedBound"></a><span class="hs-comment">{-# INLINE word64HexFixedBound #-}</span>
<a name="line-853"></a><span class="hs-definition">word64HexFixedBound</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Char</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Word64</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-conid">Word64</span>
<a name="line-854"></a><span class="hs-definition">word64HexFixedBound</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">genHexFixedBound</span> <span class="hs-varid">shiftr_w64</span>
<a name="line-855"></a>
<a name="line-856"></a><a name="genDecFixedBound"></a><span class="hs-comment">-- | Note: Works only for positive numbers.</span>
<a name="line-857"></a><span class="hs-comment">{-# INLINE genDecFixedBound #-}</span>
<a name="line-858"></a><span class="hs-definition">genDecFixedBound</span> <span class="hs-keyglyph">::</span> <span class="hs-layout">(</span><span class="hs-conid">Num</span> <span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-conid">Bits</span> <span class="hs-varid">a</span><span class="hs-layout">,</span> <span class="hs-conid">Integral</span> <span class="hs-varid">a</span><span class="hs-layout">)</span>
<a name="line-859"></a>                 <span class="hs-keyglyph">=&gt;</span> <span class="hs-conid">Char</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-varid">a</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-varid">a</span>
<a name="line-860"></a><span class="hs-definition">genDecFixedBound</span> <span class="hs-varid">padding0</span> <span class="hs-varid">bound</span> <span class="hs-keyglyph">=</span>
<a name="line-861"></a>    <span class="hs-varid">fixedEncoding</span> <span class="hs-varid">n0</span> <span class="hs-varid">io</span>
<a name="line-862"></a>  <span class="hs-keyword">where</span>
<a name="line-863"></a>    <span class="hs-varid">n0</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">max</span> <span class="hs-num">1</span> <span class="hs-varop">$</span> <span class="hs-varid">appsUntilZero</span> <span class="hs-layout">(</span><span class="hs-varop">`div`</span> <span class="hs-num">10</span><span class="hs-layout">)</span> <span class="hs-varid">bound</span>
<a name="line-864"></a>
<a name="line-865"></a>    <span class="hs-varid">padding</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">fromIntegral</span> <span class="hs-layout">(</span><span class="hs-varid">ord</span> <span class="hs-varid">padding0</span><span class="hs-layout">)</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Word8</span>
<a name="line-866"></a>
<a name="line-867"></a>    <span class="hs-varid">io</span> <span class="hs-varop">!</span><span class="hs-varid">x0</span> <span class="hs-varop">!</span><span class="hs-varid">op0</span> <span class="hs-keyglyph">=</span>
<a name="line-868"></a>        <span class="hs-varid">loop</span> <span class="hs-layout">(</span><span class="hs-varid">op0</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-varid">n0</span><span class="hs-layout">)</span> <span class="hs-varid">x0</span>
<a name="line-869"></a>      <span class="hs-keyword">where</span>
<a name="line-870"></a>        <span class="hs-varid">loop</span> <span class="hs-varop">!</span><span class="hs-varid">op</span> <span class="hs-varop">!</span><span class="hs-varid">x</span> <span class="hs-keyglyph">=</span> <span class="hs-keyword">do</span>
<a name="line-871"></a>           <span class="hs-keyword">let</span> <span class="hs-varop">!</span><span class="hs-varid">op'</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">op</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span>
<a name="line-872"></a>               <span class="hs-varop">!</span><span class="hs-varid">x'</span>  <span class="hs-keyglyph">=</span> <span class="hs-varid">x</span> <span class="hs-varop">`div`</span> <span class="hs-num">10</span>
<a name="line-873"></a>           <span class="hs-varid">poke</span> <span class="hs-varid">op'</span> <span class="hs-layout">(</span><span class="hs-layout">(</span><span class="hs-varid">fromIntegral</span> <span class="hs-varop">$</span> <span class="hs-layout">(</span><span class="hs-varid">x</span> <span class="hs-comment">-</span> <span class="hs-varid">x'</span> <span class="hs-varop">*</span> <span class="hs-num">10</span><span class="hs-layout">)</span> <span class="hs-varop">+</span> <span class="hs-num">48</span><span class="hs-layout">)</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Word8</span><span class="hs-layout">)</span>
<a name="line-874"></a>           <span class="hs-varid">unless</span> <span class="hs-layout">(</span><span class="hs-varid">op'</span> <span class="hs-varop">&lt;=</span> <span class="hs-varid">op0</span><span class="hs-layout">)</span> <span class="hs-varop">$</span>
<a name="line-875"></a>             <span class="hs-keyword">if</span> <span class="hs-varid">x'</span> <span class="hs-varop">==</span> <span class="hs-num">0</span>
<a name="line-876"></a>               <span class="hs-keyword">then</span> <span class="hs-varid">pad</span> <span class="hs-layout">(</span><span class="hs-varid">op'</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-877"></a>               <span class="hs-keyword">else</span> <span class="hs-varid">loop</span> <span class="hs-varid">op'</span> <span class="hs-varid">x'</span>
<a name="line-878"></a>
<a name="line-879"></a>        <span class="hs-varid">pad</span> <span class="hs-varop">!</span><span class="hs-varid">op</span>
<a name="line-880"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">op</span> <span class="hs-varop">&lt;</span> <span class="hs-varid">op0</span>  <span class="hs-keyglyph">=</span> <span class="hs-varid">return</span> <span class="hs-conid">()</span>
<a name="line-881"></a>          <span class="hs-keyglyph">|</span> <span class="hs-varid">otherwise</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">poke</span> <span class="hs-varid">op</span> <span class="hs-varid">padding</span> <span class="hs-varop">&gt;&gt;</span> <span class="hs-varid">pad</span> <span class="hs-layout">(</span><span class="hs-varid">op</span> <span class="hs-varop">`plusPtr`</span> <span class="hs-layout">(</span><span class="hs-comment">-</span><span class="hs-num">1</span><span class="hs-layout">)</span><span class="hs-layout">)</span>
<a name="line-882"></a>
<a name="line-883"></a><a name="wordDecFixedBound"></a><span class="hs-comment">{-# INLINE wordDecFixedBound #-}</span>
<a name="line-884"></a><span class="hs-definition">wordDecFixedBound</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Char</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Word</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-conid">Word</span>
<a name="line-885"></a><span class="hs-definition">wordDecFixedBound</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">genDecFixedBound</span>
<a name="line-886"></a>
<a name="line-887"></a><a name="word64DecFixedBound"></a><span class="hs-comment">{-# INLINE word64DecFixedBound #-}</span>
<a name="line-888"></a><span class="hs-definition">word64DecFixedBound</span> <span class="hs-keyglyph">::</span> <span class="hs-conid">Char</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">Word64</span> <span class="hs-keyglyph">-&gt;</span> <span class="hs-conid">FixedEncoding</span> <span class="hs-conid">Word64</span>
<a name="line-889"></a><span class="hs-definition">word64DecFixedBound</span> <span class="hs-keyglyph">=</span> <span class="hs-varid">genDecFixedBound</span>
<a name="line-890"></a>
</pre></body>
</html>
